<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>state/ContribField.jsx - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Alternatives.html">Alternatives</a><ul class='methods'><li data-type='method'><a href="Alternatives.html#next">next</a></li><li data-type='method'><a href="Alternatives.html#render">render</a></li></ul></li><li><a href="App.html">App</a></li><li><a href="ByValue.html">ByValue</a></li><li><a href="CheckboxI.html">CheckboxI</a><ul class='methods'><li data-type='method'><a href="CheckboxI.html#render">render</a></li></ul></li><li><a href="ContribField.html">ContribField</a><ul class='methods'><li data-type='method'><a href="ContribField.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="ContribField.html#newValToState">newValToState</a></li></ul></li><li><a href="ContribItem.html">ContribItem</a><ul class='methods'><li data-type='method'><a href="ContribItem.html#componentDidMount">componentDidMount</a></li></ul></li><li><a href="Contribs.html">Contribs</a></li><li><a href="ContribsFiltered.html">ContribsFiltered</a><ul class='methods'><li data-type='method'><a href="ContribsFiltered.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="ContribsFiltered.html#render">render</a></li></ul></li><li><a href="ContribTitle.html">ContribTitle</a></li><li><a href="DocHtml.html">DocHtml</a></li><li><a href="DocPdf.html">DocPdf</a></li><li><a href="Facet.html">Facet</a></li><li><a href="FilterCompute.html">FilterCompute</a><ul class='methods'><li data-type='method'><a href="FilterCompute.html#render">render</a></li></ul></li><li><a href="FullText.html">FullText</a></li><li><a href="Login.html">Login</a><ul class='methods'><li data-type='method'><a href="Login.html#componentDidMount">componentDidMount</a></li></ul></li><li><a href="module-DocMd-DocMd.html">DocMd</a><ul class='methods'><li data-type='method'><a href="module-DocMd-DocMd.html#fetchText">fetchText</a></li><li data-type='method'><a href="module-DocMd-DocMd.html#render">render</a></li></ul></li><li><a href="module-Doc-Doc.html">Doc</a></li><li><a href="module-EUMap-EUMap.html">EUMap</a><ul class='methods'><li data-type='method'><a href="module-EUMap-EUMap.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="module-EUMap-EUMap.html#componentDidUpdate">componentDidUpdate</a></li><li data-type='method'><a href="module-EUMap-EUMap.html#render">render</a></li></ul></li><li><a href="module-Filters-Filters.html">Filters</a></li><li><a href="NavLink.html">NavLink</a></li><li><a href="NotFound.html">NotFound</a></li><li><a href="Notification.html">Notification</a><ul class='methods'><li data-type='method'><a href="Notification.html#computeProgress">computeProgress</a></li><li data-type='method'><a href="Notification.html#render">render</a></li><li data-type='method'><a href="Notification.html#setView">setView</a></li></ul></li><li><a href="Provider.html">Provider</a><ul class='methods'><li data-type='method'><a href="Provider.html#getChildContext">getChildContext</a></li></ul></li><li><a href="Stats.html">Stats</a></li><li><a href="Store.html">Store</a><ul class='methods'><li data-type='method'><a href="Store.html#get">get</a></li><li data-type='method'><a href="Store.html#load">load</a></li><li data-type='method'><a href="Store.html#save">save</a></li></ul></li><li><a href="ValueList.html">ValueList</a><ul class='methods'><li data-type='method'><a href="ValueList.html#componentDidMount">componentDidMount</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-data.html">data</a><ul class='methods'><li data-type='method'><a href="module-data.html#.getData">getData</a></li></ul></li><li><a href="module-Doc.html">Doc</a></li><li><a href="module-DocMd.html">DocMd</a><ul class='methods'><li data-type='method'><a href="module-DocMd.html#~RouterLink">RouterLink</a></li></ul></li><li><a href="module-ES6.html">ES6</a></li><li><a href="module-EUMap.html">EUMap</a><ul class='methods'><li data-type='method'><a href="module-EUMap.html#~computeRadius">computeRadius</a></li><li data-type='method'><a href="module-EUMap.html#~inDariah">inDariah</a></li></ul></li><li><a href="module-europe_geo_js.html">europe_geo_js</a></li><li><a href="module-filtering.html">filtering</a><ul class='methods'><li data-type='method'><a href="module-filtering.html#.compileFiltering">compileFiltering</a></li><li data-type='method'><a href="module-filtering.html#.computeFiltering">computeFiltering</a></li><li data-type='method'><a href="module-filtering.html#.newFilterSettings">newFilterSettings</a></li><li data-type='method'><a href="module-filtering.html#.placeFacets">placeFacets</a></li><li data-type='method'><a href="module-filtering.html#.testAllChecks">testAllChecks</a></li><li data-type='method'><a href="module-filtering.html#~countFacets">countFacets</a></li><li data-type='method'><a href="module-filtering.html#~facetCheck">facetCheck</a></li><li data-type='method'><a href="module-filtering.html#~fullTextCheck">fullTextCheck</a></li></ul></li><li><a href="module-Filters.html">Filters</a></li><li><a href="module-hoc.html">hoc</a><ul class='methods'><li data-type='method'><a href="module-hoc.html#.saveState">saveState</a></li><li data-type='method'><a href="module-hoc.html#.withContext">withContext</a></li></ul></li><li><a href="module-main.html">main</a></li><li><a href="module-React.html">React</a></li><li><a href="module-ui.html">ui</a><ul class='methods'><li data-type='method'><a href="module-ui.html#.columnStyle">columnStyle</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Component.html">Component</a></li><li><a href="external-componentDidMount.html">componentDidMount</a></li><li><a href="external-componentDidUpdate.html">componentDidUpdate</a></li><li><a href="external-componentWillMount.html">componentWillMount</a></li><li><a href="external-componentWillReceiveProps.html">componentWillReceiveProps</a></li><li><a href="external-componentWillUnmount.html">componentWillUnmount</a></li><li><a href="external-constructor.html">constructor</a></li><li><a href="external-context.html">context</a></li><li><a href="external-ControlledComponent.html">ControlledComponent</a></li><li><a href="external-DOM.html">DOM</a></li><li><a href="external-Fragment.html">Fragment</a></li><li><a href="external-LifeCycle.html">LifeCycle</a></li><li><a href="external-Map.html">Map</a></li><li><a href="external-Promise.html">Promise</a></li><li><a href="external-PropTypes.html">PropTypes</a></li><li><a href="external-Recompose.html">Recompose</a></li><li><a href="external-Reconciliation.html">Reconciliation</a></li><li><a href="external-Redux.html">Redux</a></li><li><a href="external-render.html">render</a></li><li><a href="external-Routing.html">Routing</a></li><li><a href="external-setState.html">setState</a></li><li><a href="external-state.html">state</a></li><li><a href="external-StatePolicy.html">StatePolicy</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">state/ContribField.jsx</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { Component } from 'react'

import { getData } from '../helpers/data.js'
import { withContext, saveState } from '../helpers/hoc.js'

const normalizeValues = ({initValues}) => {
  const savedValues = (initValues == null) ? [] : initValues;
  const curValues = [...savedValues];
  return { curValues, savedValues, reasons: {}, save: {}, relValues: null }
}

const userAsString = (valRaw, usersMap) => {
  const valId = valRaw._id;
  let valRep;
  if (!usersMap.has(valId)) {
    valRep = 'UNKNOWN';
  }
  else {
    const userData = usersMap.get(valId);
    const fname = userData.firstName || '';
    const lname = userData.lastName || '';
    const email = userData.email || '';
    const eppn = userData.eppn || '';
    const authority = userData.authority || '';
    const mayLogin = userData.mayLogin?'yes':'no';
    let linkText = [fname, lname].filter(x => x).join(' '); 
    if (!linkText) {linkText = email}
    const namePart = (linkText &amp;&amp; email)? (
      `[${linkText}](mailto:${email})`
    ) : (
      linkText+email
    );
    const eppnPart = eppn?` eppn=${eppn} `:'';
    const authorityPart = authority?` authenticated by=${authority} `:'';
    const mayLoginPart = mayLogin?` active=${mayLogin} `:'';
    valRep = [namePart, eppnPart, authorityPart, mayLoginPart].filter(x => x).join('; ');
  }
  return valRep
}

const validate = (val, valType, validation) => {
  let rawVal = val;
  let vstatus = true;
  let reason = '';
  if (validation.nonEmpty &amp;&amp; (val == null || val == '')) {
    reason = `field may not be empty`;
    vstatus =  false;
  }
  if (validation.min != null || validation.max != null) {
    if (isNaN(val)) {
      reason = `value must be a number`;
      vstatus = false;
    }
    else {
      const valn = parseInt(val);
      if (!(validation.min &lt;= valn)){
        reason = `value must be at least ${validation.min}`;
        vstatus = false;
      }
        if (!(validation.max >= val)) {
        reason = `value must be at most ${validation.max}`;
        vstatus = false;
      }
    }
  }
  if (valType == 'datetime') {
    console.log('VALIDATE val=', val);
    let times;
    try {
      times = Date.parse(val);
    }
    catch (error) {
      reason = `not a valid date/time - ${error}`;
      vstatus = false;
      rawVal = null;
    }
    if (isNaN(times)) {
      reason = `not a valid date/time`;
      vstatus = false;
      rawVal = null;
    }
    else {
      rawVal = {'$date': times}
    }
  }
  console.log(vstatus);
  return { rawVal, vstatus, reason};
}

/**
 * @class
 * @classdesc
 *
 * **stateful** {@link external:Component|Component}
 *
 * ## A single contribution record
 *
 * Displays all fields that the user is entitled to read.
 * With a control to edit the record.
 * 
 * For the actual editing I intend to use
 * {@link https://github.com/kaivi/riek|React Inline Edit Kit}
 *
 */
class ContribField extends Component {
/**
 *
 * @method
 * @param {Contrib[]} contribdata (from *state*) The list of contribution records as it comes form mongo db,
 * plus a list of fields that is provided for each row (dependent on user permissions)
 * @returns {Fragment}
*/

  newValToState(i, newVal, reason) {
    const newValues = [...this.state.curValues];
    newValues[i] = newVal;
    this.setState({
      ...this.state,
      curValues: newValues,
      reasons: {...this.state.reasons, [i]: reason}
    })
  }

  newSaveToState(newValues) {
    this.setState({
      ...this.state,
      savedValues: [...newValues],
    })
  }

  changeVal(i, _id, event) {
    event.preventDefault();
    const { valType, validation } = this.props;
    const newVal = event.target.value;
    const { rawVal, vstatus, reason } = validate(newVal, valType, validation);
    const sendVal = { _id }
    if (rawVal != null) {
      sendVal.value = rawVal
    }
    else {
      sendVal.dvalue = newVal
    }
    this.newValToState(i, sendVal, reason);
  }

  saveField(event) {
    const { name, rowId, valType, validation, convert, multiple, allowNew } = this.props;
    const { savedValues, curValues, reasons } = this.state;
    const valid = Object.keys(reasons).every(i => !reasons[i]);
    let changed = false;
    console.log(savedValues, curValues);
    if (curValues.length != savedValues.length) {
      changed = true
    }
    else {
      for (const i in curValues) {
        const cv = curValues[i];
        const sv = savedValues[i];
        for (const k of Object.keys(cv)) {
          if (cv[k] != sv[k]) {
            changed = true;
            break;
          }
        }
        if (changed) {
          break;
        }
      }
    }
        
    if (!valid || !changed) {
      console.log('not saving');
      return
    }
    console.log('saving');
    this.newSaveToState(curValues);
  }

  valueAsString(valRaw) {
    const { valType, convert, usersMap } = this.props;
    const valdval = valRaw.dvalue;
    if (valdval != null) {
      return valdval
    }
    const valval = valRaw.value;
    switch (valType) {
      case 'rel': {
        switch (convert) {
          case 'user': {return userAsString(valRaw, usersMap)}
          case 'country': {return `${valRaw._id}=${valval}`}
          default: {return valval}
        }
      }
      case 'datetime': {return (new Date(valval['$date'])).toISOString()}
      default: {return valval}
    }
  }

  valuesAsReadonly() {
    const { curValues } = this.state;
    if (curValues.length == 0) {return &lt;span className='absent'>no value&lt;/span>}
    const { valType, multiple, convert } = this.props;
    const fragments = [];
    curValues.forEach((v, i) => {
      const text = this.valueAsString(v);
      const classNames = ['value', valType];
      let fragment;
      switch (valType) {
        case 'url': {
          fragment = &lt;a key={i} target="_blank" href={text} className={classNames.join(' ')}>{text}&lt;/a>;
          break
        }
        case 'email': {
          fragment = &lt;a key={i} target="_blank" href={`mailto:${text}`} className={classNames.join(' ')}>{text}&lt;/a>;
          break;
        }
        case 'markdown': {
          fragment = &lt;span key={i} className={classNames.join(' ')}>{text}&lt;/span>;
          break;
        }
        default: {
          fragment = &lt;span key={i} className={classNames.join(' ')}>{text}&lt;/span>;
          break;
        }
      }
      if (multiple || i == 0) {fragments.push(fragment)}
      if (multiple) {fragments.push(' ')}
    });
    return fragments
  }

  valuesAsControls() {
    const { curValues, reasons } = this.state;
    const { name, valType, multiple, validation, allowNew } = this.props;
    const fragments = [];
    curValues.forEach((v, i) => {
      const text = this.valueAsString(v);
      const _id = v._id;
      const classNames = ['value', valType];
      const reason = reasons[i] || '';
      if (reason != '') {
        classNames.push('invalid');
      }
      let fragment;
      switch (valType) {
        case 'rel': {
          fragment = (&lt;span key={i}
            className={classNames.join(' ')}
          >{text}&lt;/span>);
          break
        }
        case 'url': {
          fragment = (&lt;input key={i} type="text"
            className={classNames.join(' ')}
            defaultValue={text}
            onChange={this.changeVal.bind(this, i, _id)}
            size="50"
          />);
          break
        }
        case 'email': {
          fragment = (&lt;input key={i} type="text"
            className={classNames.join(' ')}
            defaultValue={text}
            onChange={this.changeVal.bind(this, i, _id)}
            size="50"
          />);
          break
        }
        case 'datetime': {
          fragment = (&lt;input key={i} type="text"
            className={classNames.join(' ')}
            defaultValue={text}
            onChange={this.changeVal.bind(this, i, _id)}
            size="50"
          />);
          break
        }
        case 'range': {
          fragment = (&lt;input key={i} type="text"
            className={classNames.join(' ')}
            defaultValue={text}
            onChange={this.changeVal.bind(this, i, _id)}
          />);
          break
        }
        case 'textarea': {
          fragment = (&lt;textarea key={i}
            className={classNames.join(' ')}
            defaultValue={text}
            onChange={this.changeVal.bind(this, i, _id)}
            rows="10"
            cols="50"
            wrap="soft"
          />);
          break;
        }
        case 'text': {
          classNames.push(valType);
          fragment = (&lt;input key={i} type="text"
            className={classNames.join(' ')}
            defaultValue={text}
            onChange={this.changeVal.bind(this, i, _id)}
            size="50"
          />);
          break;
        }
      }
      if (multiple || i == 0) {
        fragments.push(fragment);
        if (reason != '') {
          fragments.push(' ');
          fragments.push(&lt;span key={`r_${i}`} className="reason">{reason}&lt;/span>)
        }
      }
      if (multiple) {fragments.push(' ')}
    });
    return fragments
  }

  render() {
    const { relValues } = this.state;
    const { editable, valType } = this.props;
    if (editable &amp;&amp; relValues == null &amp;&amp; (valType == 'rel')) {
      return null;
    }
    return editable ? (
      &lt;p className="editable" onBlur={this.saveField.bind(this)}>{this.valuesAsControls()}&lt;/p>
    ):(
      &lt;p className="readonly">{this.valuesAsReadonly()}&lt;/p>
    )
  }

/**
 * @method
 * @param {Contrib[]} contribs (from *state*) The list of contribution records as it comes form mongo db
 * @returns {Object} The data fetched from the server.
*/
  componentDidMount() {
    const { relValues } = this.state;
    const { valType, getValues } = this.props;
    if (valType == 'rel' &amp;&amp; relValues == null) {
      getData([
          {
            type: 'db',
            path: getValues,
            branch: 'relValues'
          },
        ],
        this,
        this.props.notification.component
      );
    }
  }
}

export default withContext(saveState(ContribField, 'ContribField', normalizeValues))
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Wed Jan 25 2017 18:08:45 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
