<!doctype html><html lang=en class=no-js> <head><link href=https://fonts.gstatic.com rel=preconnect crossorigin><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="The technical documentation of the DARIAH Contribution Tool. Design, specs, rationales, patterns, diagrams.
"><link href=https://dans-labs.github.io/dariah/Functionality/Workflow/ rel=canonical><meta name=author content="Dirk Roorda"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../icons/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-dans-4.4.1"><title>Workflow - Tech Doc DARIAH contribution tool</title><link rel=stylesheet href=../../assets/stylesheets/application.27a306a7.css><script src=../../assets/javascripts/modernizr.74668098.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|Glegoo:300,400,400i,700|Ubuntu+Mono&display=swap"><style>.body-type,body,input{font-family:"Open Sans",sans-serif}.head-type,h1,h2,h3,h4,h5{font-family:"Glegoo",serif}.code-type,code,kbd,pre{font-family:"Ubuntu Mono",monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#workflow-engine tabindex=1 class=md-skip> Skip to content </a> <header class="md-header md-dev" data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://www.dariah.eu title=DARIAH class="md-header-nav__button md-logo"> <img src=../../images/dariah.png height=50> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://dans-labs.github.io/dariah/ title="Tech Doc DARIAH contribution tool" class="md-header-nav__button md-logo"> <img src=../../images/inkind_logo.png height=50> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title head-type" data-md-component=title> <span class=md-header-nav__topic> Tech Doc DARIAH contribution tool <span class="md-dev-inline head-type"> still in beta </span> </span> <span class=md-header-nav__topic> Workflow <span class="md-dev-inline head-type"> still in beta </span> </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/dans-labs/dariah/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> Dans-labs/dariah </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. title=Home class="md-tabs__link head-type"> Home </a> </li> <li class=md-tabs__item> <a href=../../About/Codebase/ title=About class="md-tabs__link head-type"> About </a> </li> <li class=md-tabs__item> <a href=../Business/ title=Functionality class="md-tabs__link md-tabs__link--active head-type"> Functionality </a> </li> <li class=md-tabs__item> <a href=../../Legacy/Content/ title=Legacy class="md-tabs__link head-type"> Legacy </a> </li> <li class=md-tabs__item> <a href=../../Concepts/Architecture/ title=Concepts class="md-tabs__link head-type"> Concepts </a> </li> <li class=md-tabs__item> <a href=../../Server/Authentication/ title=Server class="md-tabs__link head-type"> Server </a> </li> <li class=md-tabs__item> <a href=../../Client/Components/ title=Client class="md-tabs__link head-type"> Client </a> </li> <li class=md-tabs__item> <a href=../../Technology/Tech/ title=Technology class="md-tabs__link head-type"> Technology </a> </li> <li class=md-tabs__item> <a href=../../Integration/API/ title=Integration class="md-tabs__link head-type"> Integration </a> </li> <li class=md-tabs__item> <a href=../../Maintenance/Deploy/ title=Maintenance class="md-tabs__link head-type"> Maintenance </a> </li> </ul> </div> </nav> <main class=md-main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title head-type md-nav__title--site" for=__drawer> <a href=https://dans-labs.github.io/dariah/ title="Tech Doc DARIAH contribution tool" class="md-nav__button md-logo"> <img src=../../images/inkind_logo.png width=48 height=48> </a> Tech Doc DARIAH contribution tool </label> <div class=md-nav__source> <a href=https://github.com/dans-labs/dariah/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> Dans-labs/dariah </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Home class="md-nav__link head-type"> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class="md-nav__link head-type" for=nav-2> About </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-2> About </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../About/Codebase/ title=Codebase class="md-nav__link head-type"> Codebase </a> </li> <li class=md-nav__item> <a href=../../About/Stats/ title=Stats class="md-nav__link head-type"> Stats </a> </li> <li class=md-nav__item> <a href=../../About/News/ title=News class="md-nav__link head-type"> News </a> </li> <li class=md-nav__item> <a href=../../About/Lessons/ title=Lessons class="md-nav__link head-type"> Lessons </a> </li> <li class=md-nav__item> <a href=../../About/Diagrams/ title=Diagrams class="md-nav__link head-type"> Diagrams </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class="md-nav__link head-type" for=nav-3> Functionality </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-3> Functionality </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Business/ title=Business class="md-nav__link head-type"> Business </a> </li> <li class=md-nav__item> <a href=../Tables/ title=Tables class="md-nav__link head-type"> Tables </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active head-type" for=__toc> Workflow </label> <a href=./ title=Workflow class="md-nav__link md-nav__link--active head-type"> Workflow </a> <nav class="md-nav md-nav--secondary"> <label class="md-nav__title head-type" for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#description title=Description class="md-nav__link head-type"> Description </a> </li> <li class=md-nav__item> <a href=#realization title=Realization class="md-nav__link head-type"> Realization </a> </li> <li class=md-nav__item> <a href=#inspecting-other-records title="Inspecting other records" class="md-nav__link head-type"> Inspecting other records </a> </li> <li class=md-nav__item> <a href=#computing-attributes title="Computing attributes" class="md-nav__link head-type"> Computing attributes </a> </li> <li class=md-nav__item> <a href=#hooks title=Hooks class="md-nav__link head-type"> Hooks </a> </li> <li class=md-nav__item> <a href=#wiring title=Wiring class="md-nav__link head-type"> Wiring </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class="md-nav__link head-type" for=nav-4> Legacy </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-4> Legacy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Legacy/Content/ title=Content class="md-nav__link head-type"> Content </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class="md-nav__link head-type" for=nav-5> Concepts </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-5> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Concepts/Architecture/ title=Architecture class="md-nav__link head-type"> Architecture </a> </li> <li class=md-nav__item> <a href=../../Concepts/Model/ title=Model class="md-nav__link head-type"> Model </a> </li> <li class=md-nav__item> <a href=../../Concepts/Routing/ title=Routing class="md-nav__link head-type"> Routing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class="md-nav__link head-type" for=nav-6> Server </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-6> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Server/Authentication/ title=Authentication class="md-nav__link head-type"> Authentication </a> </li> <li class=md-nav__item> <a href=../../Server/Server/ title=Server class="md-nav__link head-type"> Server </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class="md-nav__link head-type" for=nav-7> Client </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-7> Client </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Client/Components/ title=Components class="md-nav__link head-type"> Components </a> </li> <li class=md-nav__item> <a href=../../Client/Dux/ title=Dux class="md-nav__link head-type"> Dux </a> </li> <li class=md-nav__item> <a href=../../Client/Templates/ title=Templates class="md-nav__link head-type"> Templates </a> </li> <li class=md-nav__item> <a href=../../Client/Lib/ title=Lib class="md-nav__link head-type"> Lib </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8 type=checkbox id=nav-8> <label class="md-nav__link head-type" for=nav-8> Technology </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-8> Technology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Technology/Tech/ title=Tech class="md-nav__link head-type"> Tech </a> </li> <li class=md-nav__item> <a href=../../Technology/ES6/ title=ES6 class="md-nav__link head-type"> ES6 </a> </li> <li class=md-nav__item> <a href=../../Technology/React/ title=React class="md-nav__link head-type"> React </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-9 type=checkbox id=nav-9> <label class="md-nav__link head-type" for=nav-9> Integration </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-9> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Integration/API/ title=API class="md-nav__link head-type"> API </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-10 type=checkbox id=nav-10> <label class="md-nav__link head-type" for=nav-10> Maintenance </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-10> Maintenance </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Maintenance/Deploy/ title=Deploy class="md-nav__link head-type"> Deploy </a> </li> <li class=md-nav__item> <a href=../../Maintenance/Tests/ title=Tests class="md-nav__link head-type"> Tests </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class="md-nav__title head-type" for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#description title=Description class="md-nav__link head-type"> Description </a> </li> <li class=md-nav__item> <a href=#realization title=Realization class="md-nav__link head-type"> Realization </a> </li> <li class=md-nav__item> <a href=#inspecting-other-records title="Inspecting other records" class="md-nav__link head-type"> Inspecting other records </a> </li> <li class=md-nav__item> <a href=#computing-attributes title="Computing attributes" class="md-nav__link head-type"> Computing attributes </a> </li> <li class=md-nav__item> <a href=#hooks title=Hooks class="md-nav__link head-type"> Hooks </a> </li> <li class=md-nav__item> <a href=#wiring title=Wiring class="md-nav__link head-type"> Wiring </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/dans-labs/dariah/edit/master/docs/Functionality/Workflow.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=workflow-engine>Workflow Engine<a class=headerlink href=#workflow-engine title="Permanent link">&para;</a></h1> <h2 id=description>Description<a class=headerlink href=#description title="Permanent link">&para;</a></h2> <p>The workflow engine of this app is a system to handle business logic.</p> <p>Whereas the database consists of neutral things (fields, records, lists), the workflow engine weaves additional attributes around it, that indicate additional constraints.</p> <p><img alt=diag src=../../design/design.011.png></p> <p>These additional <em>workflow</em> attributes are computed by the server on the fly, and then stored in a separate table in the database: <code>workflow</code>. From then on the following happens with the workflow attributes:</p> <ul> <li>they are sent to client, together with the <em>permission</em> information for each record</li> <li>the client uses the workflow info to show or hide workflow related controls, and to suppress controls that lead to actions that violate the business logic</li> <li>the server uses the workflow info to enforce the business logic;</li> <li>the server updates the workflow attributes after any insert/update/delete action.</li> </ul> <p>No matter how good a job the client does in supporting the business logic and prohibiting actions that violate the business logic, the server always has the last word. Every access to bits and pieces in the database is first subjected to the permissions (a lower layer) and then to the additional workflow constraints.</p> <h2 id=realization>Realization<a class=headerlink href=#realization title="Permanent link">&para;</a></h2> <p>Workflow is realized at the server and at the client. To a large extent, its rules are specified in the <a href=../../Concepts/Model/ >data model</a> .</p> <details class=abstract><summary>Client</summary><p>Workflow logic is predominantly used in the <a href=../../Client/Templates/ >templates</a> , which may include workflow buttons and info panels.</p> <p>The workflow attributes are handled in the Dux <a href=../../Client/Dux/#workflow>workflow</a> .</p> <p>There are also helper functions to compute special items based on workflow information.</p> <p>The templates themselves are applied by functions defined in the library <a href=../../Client/Lib/#templates>templates</a> . These functions are given workflow attributes as arguments that they pass on to the templates.</p> </details> <p>The heart of the workflow code is at the server, in <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/workflow.py>workflow.py</a> . Its functions are called from <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/db.py>db.py</a> in many places.</p> <p>The principal functions exported are discussed here.</p> <details class=abstract><summary>readWorkflow</summary><p>Given a record in some table, this function loads the workflow attributes for that record (if any). The attributes are loaded from the workflow table. That table has records with fields <code>table</code>, <code>eId</code> and <code>attributes</code>, where <code>table</code> and <code>eId</code> specify exactly which the record in question is, and <code>attributes</code> is a dictionary of all workflow data for that record that is currently stored.</p> <details class=note><summary>read or compute</summary><p>If <code>compute=True</code> is passed, the workflow attributes will be computed. In many cases, the workflow attributes can just be read from the workflow table. But if critical data has just been modified, the workflow information has to be recomputed. See <code>adjustWorkflow</code> below how it is configured which data will trigger recomputation of workflow attributes.</p> </details> <p>The determination of workflow attributes is dictated by the <a href=../../Concepts/Model/ >data model</a> , in the individual <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables>tables</a> , under the key <code>workflow/read</code>.</p> <p>There you find a sequence of instructions by which the system can compute workflow attributes for each record in a table.</p> <p>All instructions specify a list of other records to <a href=#inspecting-other-records>inspect</a> and a method to <a href=#computing-attributes>compute</a> a value from the inspected records.</p> <details class=example><summary>assessment submission</summary><p>As an example, we show an instruction for a contribution record to inspect related values in its assessment records on the basis of which it delivers the workflow attribute <code>locked</code>.</p> <p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/contrib.yaml>contrib model</a> specifies:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>workflow</span><span class=p>:</span>
  <span class=nt>read</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">details</span>
      <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hasValue</span>
      <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
      <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment</span>
      <span class=nt>otherField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">submitted</span>
      <span class=nt>myField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
      <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class=nt>attribute</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">locked</span>
        <span class=nt>except</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">selected</span>
        <span class=nt>desc</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">has been submitted for review</span>
</pre></div> </td></tr></table> <p>Basically, this instructs the system to look at various other tables and records and fields, and if certain conditions are met the attribute <code>locked</code> is added to the workflow attributes. Note that part of the attribute is a description, which explains the reason why the attribute is set. The client may decide to show this reason on the user interface.</p> <p>Line by line:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>inspect: details
</pre></div> </td></tr></table> <p>This is an instruction to look into the detail record(s) of the current record. Other possible values are: <code>master</code>, <code>self</code>, with obvious meanings. <a href=#inspecting-other-records>Inspecting other records</a> below.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span> method: hasValue
</pre></div> </td></tr></table> <p>The name of the method by which the inspected value is taken and turned in either <code>True</code> or <code>False</code>. There is a fixed, limited supply of methods, which are hard-coded in the program, see <a href=#computing-attributes>Computing Attributes</a> below.</p> <p>Not all of the following parameters need to be present for all methods, and there are more possible parameters. The list of parameters is dependent on both the inspect method and the compute method.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>linkField: contrib
</pre></div> </td></tr></table> <p>This is the name of the field by which detail records point to their master.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>otherTable: assessment
</pre></div> </td></tr></table> <p>This is the name of the other table (which can be the master table, the details table, or the own table, depending on the value of <code>inspect</code>).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>otherField: submitted
</pre></div> </td></tr></table> <p>The name of the field in the other table to look at.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>myField: null
</pre></div> </td></tr></table> <p>The name of the field in the own table to look at.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>value: true
</pre></div> </td></tr></table> <p>A reference value to compare the inspected value with.</p> </details> </details> <details class=abstract><summary>adjustWorkflow</summary><p>Whereas <code>readWorkflow</code> computes all relevant workflow for a given record in a given table, <code>adjustWorkflow</code> delivers a list of <em>other</em> records in other tables, that need new workflow attributes after a change in a given record, whether it be an insert, update or delete.</p> <p>The determination of these attributes is dictated by the <a href=../../Concepts/Model/ >data model</a> , in the individual <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables>tables</a> , under the key <code>workflow/adjust</code>.</p> <p>Typically, when a record gets workflow attributes based on master or detail records, these attributes must be updated on any change in the master or in one of the details. The system is not clever enough to generate these adjust rules itself. We have to do that.</p> <p>For this, one can specify rules that define <code>triggerFields</code> for sets of related records. When one of those trigger fields get changed, all specified related records will get their workflow attributes recomputed.</p> <details class=example><summary>assessment submission</summary><p>Let us look at the same example, but now at its <code>adjust</code> rule in the <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/assessment.yaml>assessment table</a></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>adjust</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
  <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
  <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
  <span class=nt>triggerFields</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">assessmentType</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">submitted</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">reviewerF</span>
</pre></div> </td></tr></table> <p>It says that if an assessment record is changed, some other records are affected, namely its master record in the <code>contrib</code> table.</p> <p>But not all changes in the assessment trigger adjustments, only changes in one of the <code>triggerFields</code>, in this case obviously the field <code>submitted</code>.</p> <details class=explanation><summary>other trigger fields</summary><p>The other trigger fields, <code>assessmentType</code> and <code>reviewerF</code> are mentioned because of other workflow rules that we have not mentioned here.</p> </details> <details class=note><summary>triggers also on <code>linkField</code></summary><p>The system adds the <code>linkField</code> silently to the <code>triggerField</code>, because if we, for whatever reason, reassigned this assessment to a different contribution, then that contribution has to know it!</p> </details> </details> </details> <details class=abstract><summary>enforceWorkflow</summary><p>Finally, the server has to know the consequences of the workflow attributes for behaviour. This is dictated in the generic <a href=../../Concepts/Model/ >data model</a> , under the key <code>workflow/prevent/</code><em>attribute</em> where <code>attribute</code> is a name such as <code>locked</code> or <code>incomplete</code>, or <code>frozen</code>.</p> <p>For each attribute there are optional constraints for the <code>update</code> and <code>delete</code> actions.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>prevent</span><span class=p>:</span>
  <span class=nt>locked</span><span class=p>:</span>
<span class=hll>    <span class=nt>delete</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span class=hll>    <span class=nt>update</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</span></pre></div> </td></tr></table> <p>means that it is forbidden to delete or update a record that carries the <code>locked</code> attribute.</p> <details class=hint><summary>relax update constraints</summary><p>We can relax update constraints in several ways:</p> <details class=abstract><summary>make an exception for some fields</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>prevent</span><span class=p>:</span>
  <span class=nt>locked</span><span class=p>:</span>
<span class=hll>    <span class=nt>update</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">except</span>
</span></pre></div> </td></tr></table> <p>means that updating is not allowed except for some fields for which has been made an exception.</p> <details class=explanation><summary>Where to define exception fields?</summary><p>The list of exceptions is defined in the workflow configuration of the table in question, e.g.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span>  <span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">self</span>
    <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hasValue</span>
    <span class=nt>otherField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">submitted</span>
    <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class=nt>attribute</span><span class=p>:</span>
      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">locked</span>
<span class=hll>      <span class=nt>except</span><span class=p>:</span>
</span><span class=hll>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">submitted</span>
</span><span class=hll>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">reviewerE</span>
</span><span class=hll>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">reviewerF</span>
</span>      <span class=nt>desc</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">is being reviewed</span>
</pre></div> </td></tr></table> <p>In words, if an assessment has been submitted and is therefore locked, the submitted status and the reviewers can still be changed.</p> </details> </details> <details class=abstract><summary>prevent certain fields to change</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>prevent</span><span class=p>:</span>
  <span class=nt>locked</span><span class=p>:</span>
    <span class=nt>update</span><span class=p>:</span>
<span class=hll>      <span class=nt>submitted</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</span></pre></div> </td></tr></table> <p>means that any update that changes the value of the field <code>submitted</code> is forbidden.</p> </details> <details class=abstract><summary>prevent certain fields to get a specific value</summary><p>Here we take a real example, under attribute <code>stalled</code> instead of <code>locked</code>:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>prevent</span><span class=p>:</span>
  <span class=nt>stalled</span><span class=p>:</span>
    <span class=nt>update</span><span class=p>:</span>
      <span class=nt>submitted</span><span class=p>:</span>
<span class=hll>        <span class=nt>after</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</span></pre></div> </td></tr></table> <p>This means that any update that leads to field <code>submitted</code> having value <code>true</code> is forbidden.</p> <details class=explanation><summary>Explanation</summary><p>Here we have said that a stalled assessment cannot be submitted.</p> <details class=details><summary>Details</summary><p>For the sake of clarity, here is the rule that says when an assessment is <code>stalled</code>:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span>  <span class=nt>workflow</span><span class=p>:</span>
    <span class=nt>read</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
        <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hasDifferent</span>
        <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
        <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
        <span class=nt>otherField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">typeContribution</span>
        <span class=nt>myField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessmentType</span>
        <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
        <span class=nt>workflow</span><span class=p>:</span>
          <span class=nt>stalled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class=nt>stalledReason</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment type is different from contribution type</span>
</pre></div> </td></tr></table> <p>In words: if an assessment has an <code>assessmentType</code> field with a different value than the <code>contributionType</code> field of its master contribution, then the assessment counts as stalled.</p> </details> </details> </details> </details> </details> <details class=abstract><summary>manageWorkflow</summary><p>When the web server loads, it makes sure that correct workflow information is stored in the workflow table. It does so by dropping the existing workflow table and recomputing all workflow information from scratch.</p> <p>A sysadmin can also reset the workflow from within the app. Then the workflow table will be cleared (not dropped), and all workflow info will be recomputed.</p> <p>The <a href=../../Client/Components/#workflowinfo>WorkflowInfo</a> component presents the previous resets since the web server was last started, and gives an overview of the recomputed workflow attributes.</p> </details> <h2 id=inspecting-other-records>Inspecting other records<a class=headerlink href=#inspecting-other-records title="Permanent link">&para;</a></h2> <p>Both <code>readWorkflow</code> and <code>adjustWorkflow</code> have instructions to look up related records and then apply a computing method to all those records.</p> <p>The target records can be specified with these instructions:</p> <details class=abstract><summary>self</summary><p>Don't look further, look at yourself. The information from which workflow attributes are to be derived, is already present in the record itself.</p> </details> <details class=abstract><summary>master</summary><p>Look at your master record. A record can have multiple masters, so you have to specify</p> <ul> <li><code>linkField</code>: the field in yourself that points to the master,</li> <li><code>otherTable</code>: the table in which the master record resides.</li> </ul> </details> <details class=abstract><summary>grandmaster</summary><p>Look at the master of your master record. You have to specify</p> <ul> <li><code>interField</code>: the field in yourself that points to the intermediate master,</li> <li><code>interTable</code>: the table in which the intermediate master record resides,</li> <li><code>linkField</code>: the field in the intermediate master that points to the grandmaster,</li> <li><code>otherTable</code>: the table in which the grandmaster record resides.</li> </ul> </details> <details class=abstract><summary>details</summary><p>Look at your detail records. A record can have multiple kinds of details, so you have to specify</p> <ul> <li><code>otherTable</code>: the table that holds the details, and the</li> <li><code>linkField</code>: the field in the detail record that points to you.</li> </ul> </details> <details class=abstract><summary>granddetails</summary><p>Look at details of your detail records. You have to specify</p> <ul> <li><code>interTable</code>: the table that holds the intermediate details,</li> <li><code>interField</code>: the field in the intermediate details that points to you,</li> <li><code>otherTable</code>: the table that holds the details of the details, and the</li> <li><code>linkField</code>: the field in the details of the details that points to the intermediate details.</li> </ul> </details> <details class=abstract><summary>siblings</summary><p>Look at records with the same master. You have to specify</p> <ul> <li><code>linkField</code>: the field in yourself and your siblings that points to the master</li> <li><code>otherTable</code>: the table in which your siblings reside</li> </ul> </details> <h2 id=computing-attributes>Computing attributes<a class=headerlink href=#computing-attributes title="Permanent link">&para;</a></h2> <p>When the other records have been found, it is time to extract information from them, in order to put it into workflow attributes. There is a limited set of functions you can call, they are all listed in <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/workflow.py>worklow.py</a> and their names start with <code>_compute_</code>. Below we name them without this prefix.</p> <p>In the specifications we refer to the starting record(s) as <em>my record(s)</em> and to the reference records as <em>other record(s)</em>.</p> <details class=abstract><summary>hasValue</summary><p>Takes</p> <ul> <li><code>otherField</code>: the name of a field in an other record whose value is to be retrieved;</li> <li><code>value</code>: a reference value.</li> </ul> <p>Returns <code>{'on': True }</code> if one of the retrieved values is equal to the reference value.</p> <details class=example><summary>assessment checks whether contribution is selected</summary><p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/assessment.yaml>assessment model</a> specifies:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
  <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hasValue</span>
  <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
  <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
  <span class=nt>otherField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">selected</span>
  <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class=nt>attribute</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frozen</span>
    <span class=nt>desc</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contribution has been selected by DARIAH</span>
</pre></div> </td></tr></table> <p>In words: look up the <code>selected</code> field in a master <code>contrib</code> record, and if the value there is <code>true</code>, add the <code>on: true</code> setting to the <code>frozen</code> attribute.</p> <p>If the client sees this attribute, it can put a message on the interface that the assessment is frozen because its contribution has been selected.</p> </details> </details> <details class=abstract><summary>hasComplete</summary><p>Takes</p> <ul> <li><code>emptyFields</code>: a list of field names in the other record to be checked for emptiness.</li> </ul> <p>Returns <code>{'on': True}</code> if all of the other records have no empty field among the <code>emptyFields</code>.</p> <details class=example><summary>review checks whether decision has been taken</summary><p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/review.yaml>review model</a> specifies:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">self</span>
  <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hasComplete</span>
  <span class=nt>emptyFields</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">decision</span>
  <span class=nt>attribute</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">completed</span>
    <span class=nt>desc</span><span class=p>:</span> <span class=s>&#39;verdict</span><span class=nv> </span><span class=s>has</span><span class=nv> </span><span class=s>been</span><span class=nv> </span><span class=s>given&#39;</span>
    <span class=nt>except</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">decision</span>
</pre></div> </td></tr></table> <p>In words: a review record inspects its own <code>decision</code> field to see if it is non-empty. If so, it adds the <code>on: true</code> setting to the <code>completed</code> attribute.</p> <p>Note that a <code>completed.on</code> attribute prevents updates, but that in ghis case updates to the decision are still allowed.</p> <p>Other parts of the workflow and the permission system determine which people can change the decision.</p> </details> </details> <details class=abstract><summary>hasInComplete</summary><p>Takes</p> <ul> <li><code>emptyFields</code>: a list of field names in the other record to be checked for emptiness.</li> </ul> <p>Returns <code>{'on': True, 'n': n }</code> if one of the other records has an empty field among the <code>emptyFields</code>. If so, <code>n</code> is the number of such records.</p> <details class=example><summary>assessment checks whether some criteria have not yet been completely filled in</summary><p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/assessment.yaml>assessment model</a> specifies:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">details</span>
  <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hasIncomplete</span>
  <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment</span>
  <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">criteriaEntry</span>
  <span class=nt>emptyFields</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">score</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">evidence</span>
  <span class=nt>attribute</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">incomplete</span>
    <span class=nt>desc</span><span class=p>:</span> <span class=s>&#39;some</span><span class=nv> </span><span class=s>criteria</span><span class=nv> </span><span class=s>lack</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>score</span><span class=nv> </span><span class=s>or</span><span class=nv> </span><span class=s>evidence</span><span class=nv> </span><span class=s>({n}x)&#39;</span>
</pre></div> </td></tr></table> <p>In words: a review record inspects its own <code>decision</code> field to see if it is non-empty. If so, it adds the <code>on: true</code> setting to the <code>completed</code> attribute.</p> <p>Note that a <code>completed.on</code> attribute prevents updates, but that in ghis case updates to the decision are still allowed.</p> <p>Other parts of the workflow and the permission system determine which people can change the decision.</p> </details> </details> <details class=abstract><summary>hasDifferent</summary><p>Takes</p> <ul> <li><code>otherField</code>: the name of a field in an other record whose value is to be retrieved;</li> <li><code>myField</code>: the name of a field in my record whose value is to be retrieved; </li> </ul> <p>Returns <code>{'on': True }</code> if a value from an other record is different from a value from my record.</p> <p>??? example "assessment checks whether its contribution type agrees with that of its contribution".</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=codehilite><pre><span></span>The
[assessment model](https://github.com/Dans-labs/dariah/blob/master/server/models/tables/assessment.yaml)
specifies:

```yaml
- inspect: master
  method: hasDifferent
  linkField: contrib
  otherTable: contrib
  otherField: typeContribution
  myField: assessmentType
  attribute:
    name: stalled
    desc: assessment type is different from contribution type
```

In words: an assessment record compares its own `assessmentType` with
the `typeContribution` of its contribution record.

If so, it adds the `on: true` setting to the `stalled` attribute.

This assessment may contain important information, but its criteria no longer
match the kind of conbtribution, so the worthwhile bits of the assessment
have to be entered manually in a newly created assessment based on the
current `typeContribution`.
</pre></div> </td></tr></table> </details> <details class=abstract><summary>getValues</summary><p>Takes</p> <ul> <li><code>otherFields</code>: a list of fields in an other record whose values are to be retrieved;</li> </ul> <p>Returns</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>{</span><span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=p>[</span>
  <span class=p>{</span><span class=s1>&#39;otherField1&#39;</span><span class=p>:</span> <span class=n>value1a</span><span class=p>,</span> <span class=s1>&#39;otherField2&#39;</span><span class=p>:</span> <span class=n>value2a</span><span class=p>},</span>
  <span class=p>{</span><span class=s1>&#39;otherField1&#39;</span><span class=p>:</span> <span class=n>value1b</span><span class=p>,</span> <span class=s1>&#39;otherField2&#39;</span><span class=p>:</span> <span class=n>value2b</span><span class=p>},</span>
  <span class=o>...</span>
  <span class=p>]</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>where</p> <p><code>value1a</code> and <code>value2a</code> are values for the other fields found in the first other record,</p> <p>and</p> <p><code>value1a</code> and <code>value2a</code> are values for the other fields found in the second other record,</p> <p>and so on for all other records.</p> <details class=example><summary>assessment gathers the creators and decisions of its reviews</summary><p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/assessment.yaml>assessment model</a> specifies:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">details</span>
  <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">getValues</span>
  <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment</span>
  <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">review</span>
  <span class=nt>otherFields</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">creator</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">decision</span>
  <span class=nt>attribute</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">reviews</span>
    <span class=nt>desc</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">reviews of this same assessment</span>
</pre></div> </td></tr></table> <p>In words: an assessment record looks into its associated review records and reads off their creators and decisions.</p> </details> </details> <details class=abstract><summary>assessmentScore</summary><p>Takes :</p> <ul> <li>nothing</li> </ul> <p>Computes the overall score of an assessment, based on its detail <code>criteriaEntry</code> records.</p> <p>Returns:</p> <ul> <li>A dictionary with the score details</li> </ul> <details class=explanation><summary>Score details</summary><ul> <li><code>overall</code>: the overall score as percentage of points scored with respect to total of scorable points</li> <li><code>relevantScore</code>: the sum of the scores for all criteria that have not been scored as <code>-1</code> (non-applicable)</li> <li><code>relevantMax</code>: the total of the maximum scores for all criteria that have not been scored as <code>-1</code></li> <li><code>allMax</code>: the total of the maximum scores for all criteria</li> <li><code>relevantN</code>: the number of criteria that have not been scored as <code>-1</code></li> <li><code>allN</code>: the number of criteria.</li> <li><code>aId</code>: the id of the assessment in question.</li> </ul> <p>See more about the computation in the <a href=../Business/#scoring>business logic</a> .</p> </details> <details class=example><summary>contrib gathers the assessment scores of its assessments</summary><p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/contrib.yaml>contrib model</a> specifies:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class="p p-Indicator">-</span> <span class=nt>inspect</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">details</span>
  <span class=nt>method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessmentScore</span>
  <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">contrib</span>
  <span class=nt>otherTable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment</span>
  <span class=nt>attribute</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">score</span>
    <span class=nt>desc</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment score</span>
</pre></div> </td></tr></table> <p>In words: a contrib record looks into its associated assessment records and computes their score details and stores the resulting dictionaries in the <code>score</code> workflow attribute.</p> </details> <details class=example><summary>How the score travels to the user interface</summary><p>The workflow engine takes care that the assessment score is computed on the server whenever there is a need to do that.</p> <p>The computed workflow attributes are delivered to the client whenever the client wants to render a contribution.</p> <p>Here is a fragment of the contribution template that reads the workflow information (look at <code>w('score')</code>; <code>w()</code> is a function to read out workflow attributes for the record in question):</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>if</span> <span class=p>(</span><span class=nx>approved</span><span class=p>)</span> <span class=p>{</span>
<span class=hll>  <span class=kr>const</span> <span class=nx>scoreItems</span> <span class=o>=</span> <span class=p>(</span><span class=nx>w</span><span class=p>(</span><span class=s1>&#39;score&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>emptyO</span><span class=p>).</span><span class=nx>items</span> <span class=o>||</span> <span class=nx>emptyA</span>
</span>  <span class=kr>const</span> <span class=nx>score</span> <span class=o>=</span> <span class=nx>scoreItems</span><span class=p>.</span><span class=nx>length</span> <span class=o>?</span> <span class=nx>scoreItems</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>:</span> <span class=nx>emptyO</span>
  <span class=nx>resultApproved</span> <span class=o>=</span> <span class=p>(</span>
    <span class=o>&lt;&gt;</span>
      <span class=o>&lt;</span><span class=nx>ScoreBox</span> <span class=nx>score</span><span class=o>=</span><span class=p>{</span><span class=nx>score</span><span class=p>}</span> <span class=o>/&gt;</span>
      <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>className</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;label large workflow good&#39;</span><span class=p>}</span><span class=o>&gt;</span>
        <span class=p>{</span><span class=sb>`This contribution has been reviewed positively.`</span><span class=p>}</span>
      <span class=o>&lt;</span><span class=err>/div&gt;</span>
    <span class=o>&lt;</span><span class=err>/&gt;</span>
  <span class=p>)</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>If there are multiple assessments, the score is taken from the first one. If there is a score, it consists of a dictionary with relevant score quantities. They are passed as properties to the <a href=../../Client/Components/#scorebox>ScoreBox</a> component, which produces a nicely rendered representation of the assessment score.</p> </details> </details> <h2 id=hooks>Hooks<a class=headerlink href=#hooks title="Permanent link">&para;</a></h2> <p>There are a few hard coded workflow functions that perform special actions. They will be hooked in from other parts of the server code, especially data access.</p> <details class=abstract><summary>getActiveItems()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>getActiveItems</span><span class=p>()</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Calculates the active package, and from there the active types and criteria, given the current time. This is the backdrop for any assessment and review action.</p> </details> </details> <details class=abstract><summary>detailInsert()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>detailInsert</span><span class=p>(</span><span class=n>msgs</span><span class=p>,</span> <span class=n>table</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> <span class=n>masterRecord</span><span class=o>=</span><span class=bp>None</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Hard-coded instruction to add</p> <ul> <li><code>criteriaEntry</code> detail records after inserting an <code>assessment</code> record</li> <li><code>reviewEntry</code> detail records after inserting an <code>review</code> record</li> </ul> <p>In both cases, some business logic is coded to get the right amount of details and to prefill them with sensible values, and to check for error conditions.</p> </details> <details class=details><summary>Details</summary><p>It needs to deliver a dictionary of insertValues (field=value pairs) and a dictionary of detail records, keyed by detail table name. The values are lists of field=value dictionaries. Before <a href=#db>db</a> will proceed to insert them, the detail records will get the id of the just inserted main record. This will be used as masterId when the details get inserted.</p> </details> </details> <details class=abstract><summary>findConsolidated()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>findConsolidated</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>record</span><span class=p>,</span> <span class=n>perm</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Find consolidated records of the live <code>record</code> in <code>table</code> and return them as a list of records (json-like).</p> </details> <details class=caution><summary>Permissions</summary><p>Users that have update rights for <code>record</code> will see the full consolidated record, others see the metadata only. </p> </details> </details> <details class=abstract><summary>consolidateRecord()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>consolidateRecord</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>record</span><span class=p>,</span> <span class=n>workflow</span><span class=p>,</span> <span class=n>msgs</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Hard-coded instruction to consolidate contribution records and all its detail assessment, criteriaEntry, review, and reviewEntry records.</p> <p>This happens only when a contribution is (de)selected by a national coordinator and/or a backoffice person.</p> <p>The relevant workflow attributes are taken into account and serialized.</p> <p>A provenance trail is added to the consolidated record: who (de)selected the contribution and the time of (de)selection and the time of consolidation.</p> </details> </details> <h2 id=wiring>Wiring<a class=headerlink href=#wiring title="Permanent link">&para;</a></h2> <p>Let us finish with an example, to show the intricate wiring of data that is going on in the workflow system.</p> <p><img alt=diag src=../../design/design.012.png></p> <details class=explanation><summary>Explanation</summary><p>Above we see a good deal of the workflow rules that govern contributions and their assessments and reviews, each with their detail records of criteria entries (in the self-assessment) and review entries (in the reviews).</p> <details class=abstract open=open><summary>records</summary><p>The coloured squares are particular records in the contribution, assessment, review, etc. tables. We only mention the fields that play a role in the workflow.</p> </details> <details class=abstract open=open><summary>workflow attributes</summary><p>The rounded labels indicate the workflow attributes that are computed for those records.</p> </details> <details open=open><summary>arrows</summary><p>The arrows show which fields are used for which workflow attributes.</p> <p>In fact, the arrows correspond exactly with the <code>workflow/read</code> and <code>workflow/adjust</code> instructions given in the <a href=../../Concepts/Model/ >data model</a> .</p> <p>The reading of an arrow is like this:</p> <ol> <li><strong>read workflow</strong>: whenever a record needs to be sent to the client, compute the indicated workflow labels, based on the information in the fields indicated by following the arrows in the opposite direction;</li> <li><strong>adjust workflow</strong>: whenever a record is inserted, deleted, or updated, follow any arrow from any of its fields, and for every record at the opposite end, trigger a recomputation of its workflow, and send that to the client as part of the result op the modification action.</li> </ol> </details> <details open=open><summary>effect of the workflow on the user interface</summary><p>In this way, whenever the user changes a record, not only the affected records are reported back, but also the records with updated workflow information. This will ultimately update the user interface in all relevant parts.</p> </details> </details> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../Tables/ title=Tables class="md-flex md-footer-nav__link md-footer-nav__link--prev head-type" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> Tables </span> </div> </a> <a href=../../Legacy/Content/ title=Content class="md-flex md-footer-nav__link md-footer-nav__link--next head-type" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> Content </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-disclaimer> The content of this site is produced under responsibility of project <b>Dans-labs/dariah</b> and is subject to change. </div> <div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> customised by <a href=https://github.com/Dans-labs>Dans-labs</a> </div> </div> <div class=md-footer-dans> <div>DANS is an institute of KNAW and NWO</div> <div> <a href=https://dans.knaw.nl/en title="Data Archiving and Networked Services (DANS)"><img class=md-footer-dans__img src=../../assets/images/DANS.gif height=50></a> <a target=_blank href=https://www.knaw.nl/en><img src=../../assets/images/knaw.png height=50></a> <a target=_blank href=https://www.nwo.nl/en><img src=../../assets/images/nwo.png height=50></a> </div> <div><i>Driven by data</i></div> </div> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <style>.md-footer-social__desc{font-family:"Open Sans",sans-serif;-webkit-font-smoothing:auto}</style> <ul class=md-footer-social> <li class=md-footer-social__li> <a href=http://eepurl.com/dvnr8D class="md-footer-social__link fa fa-envelope-square"> <span class=md-footer-social__desc>Newsletter</span> </a> </li> <li class=md-footer-social__li> <a href=https://twitter.com/DANSKNAW class="md-footer-social__link fa fa-twitter-square"> <span class=md-footer-social__desc>Twitter</span> </a> </li> <li class=md-footer-social__li> <a href=https://www.youtube.com/user/DANSDataArchiving class="md-footer-social__link fa fa-youtube-square"> <span class=md-footer-social__desc>YouTube</span> </a> </li> <li class=md-footer-social__li> <a href=https://www.linkedin.com/company/dans class="md-footer-social__link fa fa-linkedin-square"> <span class=md-footer-social__desc>LinkedIn</span> </a> </li> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.f780ca69.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>