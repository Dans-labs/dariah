<!doctype html><html lang=en class=no-js> <head><link href=https://fonts.gstatic.com rel=preconnect crossorigin><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="The technical documentation of the DARIAH Contribution Tool. Design, specs, rationales, patterns, diagrams.
"><link href=https://dans-labs.github.io/dariah/Server/Server/ rel=canonical><meta name=author content="Dirk Roorda"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../icons/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-dans-4.4.1"><title>Server - Tech Doc DARIAH contribution tool</title><link rel=stylesheet href=../../assets/stylesheets/application.27a306a7.css><script src=../../assets/javascripts/modernizr.74668098.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|Glegoo:300,400,400i,700|Ubuntu+Mono&display=swap"><style>.body-type,body,input{font-family:"Open Sans",sans-serif}.head-type,h1,h2,h3,h4,h5{font-family:"Glegoo",serif}.code-type,code,kbd,pre{font-family:"Ubuntu Mono",monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#server tabindex=1 class=md-skip> Skip to content </a> <header class="md-header md-dev" data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://www.dariah.eu title=DARIAH class="md-header-nav__button md-logo"> <img src=../../images/dariah.png height=50> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://dans-labs.github.io/dariah/ title="Tech Doc DARIAH contribution tool" class="md-header-nav__button md-logo"> <img src=../../images/inkind_logo.png height=50> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title head-type" data-md-component=title> <span class=md-header-nav__topic> Tech Doc DARIAH contribution tool <span class="md-dev-inline head-type"> still in beta </span> </span> <span class=md-header-nav__topic> Server <span class="md-dev-inline head-type"> still in beta </span> </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/dans-labs/dariah/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> Dans-labs/dariah </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. title=Home class="md-tabs__link head-type"> Home </a> </li> <li class=md-tabs__item> <a href=../../About/Codebase/ title=About class="md-tabs__link head-type"> About </a> </li> <li class=md-tabs__item> <a href=../../Functionality/Business/ title=Functionality class="md-tabs__link head-type"> Functionality </a> </li> <li class=md-tabs__item> <a href=../../Legacy/Content/ title=Legacy class="md-tabs__link head-type"> Legacy </a> </li> <li class=md-tabs__item> <a href=../../Concepts/Architecture/ title=Concepts class="md-tabs__link head-type"> Concepts </a> </li> <li class=md-tabs__item> <a href=../Authentication/ title=Server class="md-tabs__link md-tabs__link--active head-type"> Server </a> </li> <li class=md-tabs__item> <a href=../../Client/Components/ title=Client class="md-tabs__link head-type"> Client </a> </li> <li class=md-tabs__item> <a href=../../Technology/Tech/ title=Technology class="md-tabs__link head-type"> Technology </a> </li> <li class=md-tabs__item> <a href=../../Integration/API/ title=Integration class="md-tabs__link head-type"> Integration </a> </li> <li class=md-tabs__item> <a href=../../Maintenance/Deploy/ title=Maintenance class="md-tabs__link head-type"> Maintenance </a> </li> </ul> </div> </nav> <main class=md-main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title head-type md-nav__title--site" for=__drawer> <a href=https://dans-labs.github.io/dariah/ title="Tech Doc DARIAH contribution tool" class="md-nav__button md-logo"> <img src=../../images/inkind_logo.png width=48 height=48> </a> Tech Doc DARIAH contribution tool </label> <div class=md-nav__source> <a href=https://github.com/dans-labs/dariah/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> Dans-labs/dariah </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Home class="md-nav__link head-type"> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class="md-nav__link head-type" for=nav-2> About </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-2> About </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../About/Codebase/ title=Codebase class="md-nav__link head-type"> Codebase </a> </li> <li class=md-nav__item> <a href=../../About/Stats/ title=Stats class="md-nav__link head-type"> Stats </a> </li> <li class=md-nav__item> <a href=../../About/News/ title=News class="md-nav__link head-type"> News </a> </li> <li class=md-nav__item> <a href=../../About/Lessons/ title=Lessons class="md-nav__link head-type"> Lessons </a> </li> <li class=md-nav__item> <a href=../../About/Diagrams/ title=Diagrams class="md-nav__link head-type"> Diagrams </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class="md-nav__link head-type" for=nav-3> Functionality </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-3> Functionality </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Functionality/Business/ title=Business class="md-nav__link head-type"> Business </a> </li> <li class=md-nav__item> <a href=../../Functionality/Tables/ title=Tables class="md-nav__link head-type"> Tables </a> </li> <li class=md-nav__item> <a href=../../Functionality/Workflow/ title=Workflow class="md-nav__link head-type"> Workflow </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class="md-nav__link head-type" for=nav-4> Legacy </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-4> Legacy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Legacy/Content/ title=Content class="md-nav__link head-type"> Content </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class="md-nav__link head-type" for=nav-5> Concepts </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-5> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Concepts/Architecture/ title=Architecture class="md-nav__link head-type"> Architecture </a> </li> <li class=md-nav__item> <a href=../../Concepts/Model/ title=Model class="md-nav__link head-type"> Model </a> </li> <li class=md-nav__item> <a href=../../Concepts/Routing/ title=Routing class="md-nav__link head-type"> Routing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6 checked> <label class="md-nav__link head-type" for=nav-6> Server </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-6> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Authentication/ title=Authentication class="md-nav__link head-type"> Authentication </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active head-type" for=__toc> Server </label> <a href=./ title=Server class="md-nav__link md-nav__link--active head-type"> Server </a> <nav class="md-nav md-nav--secondary"> <label class="md-nav__title head-type" for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#perm title=perm class="md-nav__link head-type"> perm </a> </li> <li class=md-nav__item> <a href=#db title=db class="md-nav__link head-type"> db </a> </li> <li class=md-nav__item> <a href=#user title=user class="md-nav__link head-type"> user </a> </li> <li class=md-nav__item> <a href=#auth title=auth class="md-nav__link head-type"> auth </a> </li> <li class=md-nav__item> <a href=#file title=file class="md-nav__link head-type"> file </a> </li> <li class=md-nav__item> <a href=#workflow title=workflow class="md-nav__link head-type"> workflow </a> </li> <li class=md-nav__item> <a href=#info title=info class="md-nav__link head-type"> info </a> </li> <li class=md-nav__item> <a href=#utils title=utils class="md-nav__link head-type"> utils </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class="md-nav__link head-type" for=nav-7> Client </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-7> Client </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Client/Components/ title=Components class="md-nav__link head-type"> Components </a> </li> <li class=md-nav__item> <a href=../../Client/Dux/ title=Dux class="md-nav__link head-type"> Dux </a> </li> <li class=md-nav__item> <a href=../../Client/Templates/ title=Templates class="md-nav__link head-type"> Templates </a> </li> <li class=md-nav__item> <a href=../../Client/Lib/ title=Lib class="md-nav__link head-type"> Lib </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8 type=checkbox id=nav-8> <label class="md-nav__link head-type" for=nav-8> Technology </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-8> Technology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Technology/Tech/ title=Tech class="md-nav__link head-type"> Tech </a> </li> <li class=md-nav__item> <a href=../../Technology/ES6/ title=ES6 class="md-nav__link head-type"> ES6 </a> </li> <li class=md-nav__item> <a href=../../Technology/React/ title=React class="md-nav__link head-type"> React </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-9 type=checkbox id=nav-9> <label class="md-nav__link head-type" for=nav-9> Integration </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-9> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Integration/API/ title=API class="md-nav__link head-type"> API </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-10 type=checkbox id=nav-10> <label class="md-nav__link head-type" for=nav-10> Maintenance </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class="md-nav__title head-type" for=nav-10> Maintenance </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Maintenance/Deploy/ title=Deploy class="md-nav__link head-type"> Deploy </a> </li> <li class=md-nav__item> <a href=../../Maintenance/Tests/ title=Tests class="md-nav__link head-type"> Tests </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class="md-nav__title head-type" for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#perm title=perm class="md-nav__link head-type"> perm </a> </li> <li class=md-nav__item> <a href=#db title=db class="md-nav__link head-type"> db </a> </li> <li class=md-nav__item> <a href=#user title=user class="md-nav__link head-type"> user </a> </li> <li class=md-nav__item> <a href=#auth title=auth class="md-nav__link head-type"> auth </a> </li> <li class=md-nav__item> <a href=#file title=file class="md-nav__link head-type"> file </a> </li> <li class=md-nav__item> <a href=#workflow title=workflow class="md-nav__link head-type"> workflow </a> </li> <li class=md-nav__item> <a href=#info title=info class="md-nav__link head-type"> info </a> </li> <li class=md-nav__item> <a href=#utils title=utils class="md-nav__link head-type"> utils </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/dans-labs/dariah/edit/master/docs/Server/Server.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=server>Server<a class=headerlink href=#server title="Permanent link">&para;</a></h1> <p>Although this app is a single page application with most of the business logic coded at the client side, there are a bunch of things that are handled at the server side.</p> <details class=abstract><summary>Data access</summary><p>Almost all data access is handled by server side controllers that implement a data api. These controllers are informed by the <a href=../../Concepts/Model/ >data model</a> .</p> <p>When the web server starts, the data model files are read, and converted to python modules with the same base name that encapsulate the information in the YAML files.</p> <p>These modules are then imported by all controllers, so that almost all data access happens in conformance with the data model and its permissions.</p> <details class=caution><summary>Other way of data access</summary><p>The module <a href=#info><strong>info</strong></a> bypasses the regular data access methods, and peeks straight into the MongoDB data. </p> </details> </details> <h2 id=perm>perm<a class=headerlink href=#perm title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/perm.py>perm</a>.</p> <p>Contains the methods to compute permissions for controllers, tables and fields. Here are the main methods.</p> <details class=abstract><summary>allow()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>allow</span><span class=p>(</span>
    <span class=n>table</span><span class=p>,</span> <span class=n>action</span><span class=p>,</span> <span class=n>msgs</span><span class=p>,</span>
    <span class=n>verbose</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
    <span class=n>controller</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span>
    <span class=n>record</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span>
    <span class=n>newValues</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span>
    <span class=n>my</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span>
<span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Given <em>table</em> and an <em>action</em> (such as <code>read</code>, <code>update</code>), this method computes whether that <em>action</em> may be performed on behalf of the current web user.</p> <p>No workflow attributes are being used, this is a lower level operation.</p> </details> <details class=explanation><summary>msgs, verbose</summary><p>If, during the computation of the permission, circumstances occur that must be reported, they will be appended to the list <em>msgs</em>.</p> <p>If the permission is denied, <em>msgs</em> will contain the reason if <em>verbose</em> is <code>True</code>.</p> </details> <details class=explanation><summary>controller</summary><p>If given, the controller-level permissions will be looked up to see whether the <em>controller</em> may execute for the user at all. If not, no permission will be given and the computation stops.</p> </details> <details class=explanation><summary>record</summary><p>If given, this is the record in the database for which the permission is computed. If a <em>record</em> is specified, the information in that <em>record</em> will be used to determine whether the <em>record</em> has a special relationship to the user, such as <em>ownership</em>, <em>editorship</em>, or <em>same country</em> and in that case the permissions tend to be more liberal. Without a <em>record</em>, permissions are calculated as if the user does not own any <em>record</em> in the <em>table</em>.</p> </details> <details class=explanation><summary>newValues</summary><p>If given, this is (part of) the record that results from the action, and it will be used in the calculation of the permission.</p> <p>It is mainly used when one user changes the permission group of another user: we must take care that the principles of who can promote/demote and to what level are not violated.</p> </details> <details class=explanation><summary>my</summary><p>If given, it is a list of fields. These fields will be looked up in the <em>record</em>, and if the user id of the current user is listed in one of them, the record counts as "connected" to the user. Based on the other permission settings, this may lead to permit the action, which might not be permitted if there were no such connection between <em>record</em> and user.</p> </details> <details class=explanation><summary>returns</summary><details class=explanation><summary><em>good</em></summary><p>a boolean: <code>True</code>: allowed, or <code>False</code>: forbidden.</p> </details> <details class=explanation><summary><em>rowFilter</em></summary><p>specifies, in case of <em>good</em> = True, to which rows the <em>action</em> may be applied. Otherwise, the <em>rowFilter</em> is <code>None</code>.</p> <p>If a <em>record</em> is passed <em>rowFilter</em> will be also be <code>None</code>, because it is not needed.</p> <p>Only if no <em>record</em> is given, a <em>rowFilter</em> will be computed. It has the shape of a MongoDB selection criterion (a dict), but it can also be <code>False</code> (no rows) or <code>True</code> (all rows) or <code>None</code> (irrelevant). </p> <p>If the operation is not permitted on any row, <em>rowFilter</em> becomes <code>False</code>. The reaction to this outcome should be to not perform a database lookup at all.</p> <details class=note><summary>not an error</summary><p>But this is not a permission error, because in this case the list of records for which the operation is allowed is empty. This is different from <em>good</em> is <code>False</code> and <em>rowFilter</em> is <code>None</code>.</p> </details> </details> <details class=explanation><summary><em>fieldSet</em></summary><p>specifies, in case of yes, the set of fields in those rows which may be acted upon. Otherwise, the <em>fieldSet</em> is <code>None</code>.</p> <p>If no fields are permitted, <em>fieldSet</em> is returned as <code>set()</code>. This will still deliver the <code>_id</code> fields, because <code>_id</code> fields are always permitted. If all or part of the fields are permitted, the set of permitted fields is returned.</p> </details> </details> </details> <h2 id=db>db<a class=headerlink href=#db title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/db.py>db</a>.</p> <p>This is the data access module. It uses the <a href=../../Concepts/Model/ >data model</a> to serve any data to any user in such a way that no data is sent from server to client that the current user is not entitled to see.</p> <p>??? explanation 'Model driven" The code in <code>db</code> is generic, it does not contain explicit reference to particular tables and fields. All specifics are derived form the <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/model.yaml>model config file</a> and the table specific files in <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables>tables</a> .</p> <details class=explanation><summary>Workflow hooks</summary><p>There are also <em>hooks</em>, where specific behaviour for certain tables can be specified. That behaviour is coded in the <a href=#workflow>workflow module</a> .</p> </details> <details class=abstract><summary>validate()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>validate</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>itemValues</span><span class=p>,</span> <span class=n>updateFields</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Server validation of the values of a record.</p> </details> <details class=explanation><summary><em>itemValues</em></summary><p>The dictionary of all field values of the item.</p> </details> <details class=explanation><summary><em>updateFields</em></summary><p>The set of fields to be updated.</p> </details> <details class=explanation><summary>returns</summary><details class=explanation><summary>valItemValues</summary><p>A dictionary, keyed by field containing:</p> <details class=explanation><summary>valid</summary><p>A boolean that states whether all values are valid,</p> </details> <details class=explanation><summary>diags</summary><p>A dictionary of diagnostic information if there are validation errors.</p> </details> <details class=explanation><summary>msgs</summary><p>A list of error messages if the validation process itself failed.</p> </details> <details class=explanation><summary>valValues</summary><p>A list of validated values for this field.</p> </details> </details> <details class=explanation><summary>newValues</summary><p>A list of new values created in related tables.</p> </details> </details> </details> <details class=abstract><summary>getList()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>getList</span><span class=p>(</span>
    <span class=n>controller</span><span class=p>,</span> <span class=n>table</span><span class=p>,</span>
    <span class=n>data</span><span class=p>,</span> <span class=n>msgs</span><span class=p>,</span>
    <span class=n>verbose</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
    <span class=n>titleOnly</span><span class=o>=</span><span class=bp>False</span><span class=p>,</span>
    <span class=n>withValueLists</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
    <span class=n>withDetails</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
    <span class=n>my</span><span class=o>=</span><span class=bp>False</span><span class=p>,</span>
<span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>A true workhorse, that retrieves the contents of a table, in various circumstances.</p> </details> <details class=explanation><summary><em>controller</em></summary><p>is the name of the top-level method that called this function.</p> </details> <details class=explanation><summary><em>table</em></summary><p>is the name of the table in question. Permissions that are in force may cause a selection on the rows and a restriction on the fields that will be shown for each row.</p> </details> <details class=explanation><summary><em>data</em></summary><p>A dictionary that holds the results. It is keyed by table name, because a single request may need to fetch data from related tables as well.</p> </details> <details class=explanation><summary><em>msgs, verbose</em></summary><p>A list that accumulates messages incurred by fetching data and checking permissions. Will receive more messages if <em>verbose</em> is <code>True</code>.</p> </details> <details class=explanation><summary><em>titleOnly</em></summary><p>tells whether only the titles or the full data of the records should be fetched. Again: access levels may constrain the set of returned fields further.</p> </details> <details class=explanation><summary><em>withValueLists</em></summary><p>If true and if there are fields whose values reside in value lists, these value lists will be fetched as well, if needed.</p> </details> <details class=explanation><summary><em>withDetails</em></summary><p>If true, the detail records as specified by the data model whose masters are in the results, will also be fetched and returned.</p> </details> <details class=explanation><summary><em>my</em></summary><p>if True: only fetches rows that have been created by the current user.</p> <p>If <em>my</em> is a list of fields, these are <em>ourFields</em>. These fields contain user ids, and only records with the current user occurring in one of those fields, will be fetched.</p> <p>Whereas <code>my=True</code> is intended to fetch records that are owned or editable by the current user, <code>my=ourFields</code> is intended to fetch records that are connected to the current user in an other, configurable way.</p> <p>It only works if the data model of <em>table</em>, contains a section <code>ourFields</code> listing a number of fields.</p> </details> </details> <details class=abstract><summary>getItem()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>getItem</span><span class=p>(</span><span class=n>controller</span><span class=p>,</span> <span class=n>table</span><span class=p>,</span> <span class=n>eId</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Fetches a single record from a table.</p> </details> <details class=explanation><summary><em>controller</em></summary><p>is the name of the top-level method that called this function.</p> </details> <details class=explanation><summary><em>table</em>, <em>eId</em></summary><p>is the name of the table in question, and <em>eId</em> the identifier of a record in that table. Permissions that are in force may prevent the record to be fetched or cause a restriction on the fields that will be shown.</p> </details> <details class=explanation><summary>returns</summary><p>??? explanation "values" A dictionary of the values of each field in the record.</p> <p>??? explanation "perm" Whether the record may be updated and or deleted.</p> <p>??? explanation "fields" A set of field names of the fields that the user may update. This is is determined solely on the basis of the permissions, the workflow attributes do not play a role.</p> <p>??? explanation "workflow" A dictionary of all the workflow attributes associated with this record.</p> </details> </details> <details class=abstract><summary>modItem()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>modItem</span><span class=p>(</span><span class=n>controller</span><span class=p>,</span> <span class=n>table</span><span class=p>,</span> <span class=n>action</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>An other workhorse. This function can insert, update and delete a single item. New items are inserted as rows with blank fields. The information to update items is fetched from the request object. The client has sent this material to the server.</p> <details class=note><summary>workflow</summary><p>These operations are workflow-sensitive: </p> <ul> <li>before the operation, workflow attributes will be inspected in order to determine whether the action can be carried out</li> <li>after the operation, workflow attributes will be recomputed to reflect the changes to the data made by the operation.</li> </ul> </details> </details> <details class=explanation><summary><em>controller</em></summary><p>Is the name of the top-level method that called this function.</p> </details> <details class=explanation><summary><em>table</em></summary><p>Is the name of the table in question.</p> </details> <details class=explanation><summary><em>action</em></summary><p>A keyword <code>insert</code>, <code>update</code> or <code>delete</code>.</p> </details> <details class=explanation><summary>request data</summary><p>The request data should contain the data to perform the <em>action</em>:</p> <ul> <li><code>insert</code>: a dictionary of field-values for the new record;</li> <li><code>delete</code>: a dictionary containing a pair <code>_id: eId</code> which specifies the record to delete;</li> <li><code>update</code>: a modified record containing a pair <code>_id: eId</code> which specifies the record to delete;</li> </ul> </details> <details class=abstract><summary>insert</summary><p>When inserting records as details of an other record, each inserted record gets the field pointing to the master filled in.</p> <p>The workflow hook <a href=../../Functionality/Workflow/#hooks><code>detailInsert</code></a> is called to insert certain detail records after inserting the master record.</p> </details> <details class=abstract><summary>delete</summary><p>When deleting records, the questions arise:</p> <ul> <li>what if the record is used by another record as related record? Deletion would render that other record incomplete.</li> <li>what if the record has releated records? Should they be deleted too? If those are related to other records as well, those records could become incomplete?</li> </ul> <p>We deal with these questions as follows:</p> <p>The table model may specify that a certain kind of details should be cascade-deleted by means of the <code>cascade</code> key.</p> <details class=example><summary>Example</summary><p>The <a href=https://github.com/Dans-labs/dariah/blob/master/server/models/tables/assessment.yaml>assessment model</a> has</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>details</span><span class=p>:</span>
  <span class=nt>criteriaEntry</span><span class=p>:</span>
    <span class=nt>table</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">criteriaEntry</span>
    <span class=nt>linkField</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">assessment</span>
    <span class=nt>expand</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">own</span>
    <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">list</span>
    <span class=nt>border</span><span class=p>:</span> <span class="p p-Indicator">{</span>
<span class=nt>      read</span><span class=p>:</span> <span class=nv>false</span><span class="p p-Indicator">,</span>
<span class=nt>      edit</span><span class=p>:</span> <span class=nv>false</span><span class="p p-Indicator">,</span>
    <span class="p p-Indicator">}</span>
    <span class=nt>filtered</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=hll>    <span class=nt>cascade</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</span>    <span class=nt>fixed</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div> </td></tr></table> <p>This means that when an assessment is deleted, all its criteria-entries will be deleted as well. Criteria entries form an integral part of an assessment, and no criteria entry record serves multiple assessments.</p> </details> <p>If after cascade-deleting of detail records, there would remain undeleted detail records, then the record will <em>not</em> be deleted, nor any of its details. This check is carried out without deleting anything.</p> </details> <details class=abstract><summary>update</summary><p>Before an update happens, the new values will be validated on the server. If there are errors, warnings will travel to the client, and the update does not occur.</p> <p>The workflow hook <a href=../../Functionality/Workflow/#hooks><code>consolidateRecord</code></a> is called to consolidate the record if some conditions are met.</p> <details class=explanation><summary>provenance metadata</summary><p>Upon each update, it will be recorded in the updated document who did the update and when. These values will be appended to the field <code>modified</code> in a consolidated way, i.e. the name of the updater is looked up in the related table first.</p> <details class=note><summary>Filtering update times</summary><p>Recording every single update may lead to very long trails in the <code>modified</code> field. For that reason, we filter the trail for each update. Filtering thins updates made before today. For those days, it keeps for each person that modified on that day the last modification time.</p> </details> </details> </details> </details> <h2 id=user>user<a class=headerlink href=#user title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/user.py>user</a>.</p> <p>Contains the logic needed to maintain the user table. The <code>eppn</code> attribute is key to identify users. It is the name by which they are identified by the DARIAH identity provider.</p> <details class=abstract><summary>getUser()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>getUser</span><span class=p>(</span><span class=n>eppn</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=bp>None</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Return all characteristics of this user that can be found in the system, including to what permission group the user belongs.</p> </details> <details class=explanation><summary><em>eppn</em>, <em>email</em></summary><p>The <em>eppn</em> attribute is used as primary means to identify the user, and only if that does not yield a result, the email address is used.</p> </details> </details> <details class=abstract><summary>storeUpdate()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>storeUpdate</span><span class=p>(</span><span class=n>newUserInfo</span><span class=p>):</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>When new users log in through the DARIAH infrastructure, the identifying attributes from the identity provider are collected by <a href=../Authentication/ ><code>authenticate()</code></a>.</p> <p>From there, this function stores those details in the user table. Or, if there is already an entry for this user, that entry is updated with the new information gathered.</p> </details> </details> <h2 id=auth>auth<a class=headerlink href=#auth title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/auth.py>auth</a>.</p> <p>Contains the methods to authenticate users. Here all the logic about user sessions and session cookies is written down. It builds on the Flask web framework.</p> <p>It starts working when the server is started. Then it collects information from the environment to set up the cryptography for the sessions.</p> <p>And it (re)computes all workflow attributes of all records in the database from scratch.</p> <details class=abstract><summary>readBundleNames()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>readBundleNames</span><span class=p>(</span><span class=n>regime</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>This is an initialization routine which realizes <a href=../../Maintenance/Deploy/#client-code>cache busting</a> of javascript and css files.</p> <p>It is called when the <code>AuthApi</code> object is initialized.</p> <details class=explanation><summary>Cache busting</summary><p>For production, the JS and CSS bundles for the browser have names with a random hash in it, so that an update of the app will trigger all clients to fetch a new version of these bundles instead of relying on their cached versions.</p> </details> <details class=details><summary>Fiddling with the index page</summary><p>The server generates the HTML index page that will load these bundles, to we have to fiddle those hashes into the index template.</p> <p>We have set up the client build script (webpack) in such a way that the hashed file names are written to a file <code>bundle.html</code> in the distribution directory.</p> </details> </details> <details class=explanation><summary><em>regime</em></summary><p>There are several run scenarios, and inspecting the environment variable <code>REGIME</code> enables the server to determine the scenario it works in.</p> <details class=details><summary>Run scenarios</summary><p>There are three scenarios for running the DARIAH app:</p> <details class=note><summary><code>None</code></summary><p><strong>production build served by a production webserver</strong></p> <p>The server has not been started with the build script.</p> <p>Hashed file names needed.</p> </details> <details class=note><summary><code>develop</code></summary><p><strong>production build served by the local flask webserver</strong></p> <p>The server has been started by the build script with argument <code>serve</code>.</p> <p>Hashed file names needed.</p> </details> <details class=note><summary><code>hot</code></summary><p><strong>develop build served by the webpack devserver</strong></p> <p>The server has been started by the build script with argument <code>servehot</code>.</p> <p>Hashed file names <em>not</em> needed.</p> </details> </details> <p>The proper tweaking of <code>bundle.html</code> will take place for all these scenarios.</p> </details> </details> <details class=abstract><summary>authenticate()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>authenticate</span><span class=p>(</span><span class=n>login</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Tries to authenticate the current user by looking up a session created by the DARIAH identity provider, and retrieving the attributes of that session.</p> <p>If it finds unsatisfactory attributes in the session, the session will be deleted, and the user is not authenticated.</p> </details> <details class=explanation><summary><em>login</em></summary><p>This is only relevant on the development system. If <code>True</code>, the server asks for a login name on the command line, and if a valid test user is typed in, it logs that user in.</p> <p>On the production system, the login process takes place outside this app. Only after login this app is able to detect whether a user has logged in and if so, which user that is.</p> </details> </details> <details class=abstract><summary>deauthenticate()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>deauthenticate</span><span class=p>()</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Clears the info of the current user and if that user has been identified by the DARIAH identity provider, the corresponding session will be deleted.</p> </details> </details> <h2 id=file>file<a class=headerlink href=#file title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/file.py>file</a>.</p> <p>Contains the methods to get file data from the server.</p> <details class=abstract><summary>determineOrigin()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>determineOrigin</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</pre></div> </td></tr></table> <p>You can configure origin directories for static files depending on the url path.</p> <p>The configuration is in <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/file.py>file</a> itself, in the variable <code>origins</code>, which is a dictionary of initial path strings mapped to an origin directory.</p> <p>For each request for a static file, this function is called to locate the file on the server.</p> </details> <details class=abstract><summary>static()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>static</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Reads the file identified by <code>path</code> on the server and sends its contents as a static file over HTTP to the client.</p> </details> </details> <details class=abstract><summary>json()</summary><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>json</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</pre></div> </td></tr></table> <details class=explanation><summary>task</summary><p>Reads the file identified by <code>path</code> on the server and sends its contents, wrapped as JSON data over HTTP to the client.</p> </details> </details> <h2 id=workflow>workflow<a class=headerlink href=#workflow title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/workflow.py>workflow</a>.</p> <p>Implements the <a href=../../Functionality/Workflow/ >workflow engine</a> which takes care of various aspects of the business logic, just above the level of data fetching and permissions.</p> <h2 id=info>info<a class=headerlink href=#info title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/info.py>info</a>.</p> <p>This module is reponsible for an overview of the statistics of the contributions.</p> <p>National coordinators and backoffice personnel can (de)select contributions from this page.</p> <details class=note><summary>Permissions</summary><p>It does manage access to data, and takes care that every user can access the data under the proper conditions.</p> <p>It will hide the sensitive fields (cost) from unauthorized users.</p> <p>Care is taken that NCs can only take selection decisions for contributions from their own country. Backoffice users can modify any selection decision.</p> </details> <h2 id=utils>utils<a class=headerlink href=#utils title="Permanent link">&para;</a></h2> <p>See <a href=https://github.com/Dans-labs/dariah/blob/master/server/controllers/utils.py>utils</a>.</p> <p>Low level stuff.</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../Authentication/ title=Authentication class="md-flex md-footer-nav__link md-footer-nav__link--prev head-type" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> Authentication </span> </div> </a> <a href=../../Client/Components/ title=Components class="md-flex md-footer-nav__link md-footer-nav__link--next head-type" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> Components </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-disclaimer> The content of this site is produced under responsibility of project <b>Dans-labs/dariah</b> and is subject to change. </div> <div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> customised by <a href=https://github.com/Dans-labs>Dans-labs</a> </div> </div> <div class=md-footer-dans> <div>DANS is an institute of KNAW and NWO</div> <div> <a href=https://dans.knaw.nl/en title="Data Archiving and Networked Services (DANS)"><img class=md-footer-dans__img src=../../assets/images/DANS.gif height=50></a> <a target=_blank href=https://www.knaw.nl/en><img src=../../assets/images/knaw.png height=50></a> <a target=_blank href=https://www.nwo.nl/en><img src=../../assets/images/nwo.png height=50></a> </div> <div><i>Driven by data</i></div> </div> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <style>.md-footer-social__desc{font-family:"Open Sans",sans-serif;-webkit-font-smoothing:auto}</style> <ul class=md-footer-social> <li class=md-footer-social__li> <a href=http://eepurl.com/dvnr8D class="md-footer-social__link fa fa-envelope-square"> <span class=md-footer-social__desc>Newsletter</span> </a> </li> <li class=md-footer-social__li> <a href=https://twitter.com/DANSKNAW class="md-footer-social__link fa fa-twitter-square"> <span class=md-footer-social__desc>Twitter</span> </a> </li> <li class=md-footer-social__li> <a href=https://www.youtube.com/user/DANSDataArchiving class="md-footer-social__link fa fa-youtube-square"> <span class=md-footer-social__desc>YouTube</span> </a> </li> <li class=md-footer-social__li> <a href=https://www.linkedin.com/company/dans class="md-footer-social__link fa fa-linkedin-square"> <span class=md-footer-social__desc>LinkedIn</span> </a> </li> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.f780ca69.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>