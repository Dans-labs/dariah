'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally {try{if(!_n&&_i['return'])_i['return']()}finally {if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else {throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value' in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _generic=require('./generic.js');var g=_interopRequireWildcard(_generic);var _message=require('./message');var _message2=_interopRequireDefault(_message);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else {var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var _spec_info=Symbol();var _data=Symbol();var _specs=Symbol();var _msg=Symbol();var _class=function(){function _class(page){_classCallCheck(this,_class);this[_spec_info]={vars:new Set(['list','flt_contrib','flt_country','flt_type','flt_tadiraha','flt_tadiraho','flt_tadiraht','rel_country_contrib','rel_type_contrib','rel_tadiraha_contrib','rel_tadiraho_contrib','rel_tadiraht_contrib','item_contrib','item_country','sort']),vals:new Map([['list',new Set(['contrib','country','type','tadiraha','tadiraho','tadiraht'])],['sort',new Map([['v',true],['x',false]])]]),default_value:new Map([['list','contrib'],['sort',true]]),typ:new Map([['sort','boolean']]),url:new Set(['list','item_contrib','item_country']),showas:new Map([['list',new Map([['contrib',{sg:'contribution',pl:'contributions'}],['country',{sg:'country',pl:'countries'}],['type',{sg:'type',pl:'types'}],['tadiraha',{sg:'tadirah activity',pl:'tadirah activities'}],['tadiraho',{sg:'tadirah object',pl:'tadirah objects'}],['tadiraht',{sg:'tadirah technique',pl:'tadirah techniques'}]])]])};this[_data]={};this[_specs]=new Map;this.page=page;this[_msg]=new _message2.default('msg_page');this._compile_specs();this._getInitstate();this._addHistory()}_createClass(_class,[{key:'_compile_specs',value:function _compile_specs(){var info=this[_spec_info];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=info.vars[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var v=_step.value;var spec={};spec.vals=info.vals.get(v)||null;spec.default_value=info.default_value.get(v)||'';spec.typ=info.typ.get(v)||'string';spec.url=info.url.has(v);spec.showas=info.showas.get(v)||{};this[_specs].set(v,spec)}}catch(err){_didIteratorError=true;_iteratorError=err}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally {if(_didIteratorError){throw _iteratorError}}}}},{key:'_validate',value:function _validate(v,val){var newval=void 0,message=void 0;if(this[_specs].has(v)){var spec=this[_specs].get(v);if(spec.typ=='string'){if(spec.vals){if(spec.vals.has(val)){newval=val}else {newval=spec.default_value;this[_msg].msg('illegal string value for '+v+': "'+val+'" is replaced by "'+spec.default_value+'"','warning')}}else {newval=val}}else if(spec.typ=='integer'){if(/^(\-|\+)?[0-9]+$/.test(val)){newval=Number(val)}else {newval=spec.default_value;this[_msg].msg('not a number value for '+v+': "'+val+'" is replaced by "'+spec.default_value+'"','warning')}if(newval<spec.limits.min){this[_msg].msg('number to small for '+v+': "'+newval+'" is replaced by "'+spec.limits.min+'"','warning')}if(newval>spec.limits.max){this[_msg].msg('number to big for '+v+': "'+newval+'" is replaced by "'+spec.limits.max+'"','warning')}}else if(spec.typ=='boolean'){if(spec.vals.has(val)){newval=spec.vals.get(val)}else {newval=spec.default_value;this[_msg].msg('illegal boolean value for '+v+': "'+val+'" is replaced by "'+spec.default_value+'"','warning')}}}else {newval=null;this[_msg].msg('unknown parameter: '+v+'='+val,'warning')}return newval}},{key:'getVars',value:function getVars(comprehensive){var vars=[];for(var v in this[_data]){var val=this[_data][v];var spec=this[_specs].get(v);if(comprehensive||spec.url){if(spec.typ=='string'||spec.typ=='integer'){vars.push(v+'='+val)}else if(spec.typ=='boolean'){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=spec.vals[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _step2$value=_slicedToArray(_step2.value,2);var valid_val=_step2$value[0];var trans_val=_step2$value[1];if(trans_val==val){vars.push(v+'='+valid_val)}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally {if(_didIteratorError2){throw _iteratorError2}}}}}}return vars.join('&')}},{key:'_getInitstate',value:function _getInitstate(){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=g.request_vars[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var _step3$value=_slicedToArray(_step3.value,2);var v=_step3$value[0];var val=_step3$value[1];if(!this[_specs].has(v)){this[_msg].msg('unknown parameter: '+v+'='+val,'warning')}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally {try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally {if(_didIteratorError3){throw _iteratorError3}}}var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=this[_specs][Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var _step4$value=_slicedToArray(_step4.value,2);var v=_step4$value[0];var spec=_step4$value[1];var val=null;if(g.request_vars.has(v)){var raw_val=g.request_vars.get(v);val=this._validate(v,raw_val);g.localstorage_vars.set(v,val)}else if(g.localstorage_vars.isSet(v)){val=g.localstorage_vars.get(v)}else {val=spec.default_value;g.localstorage_vars.set(v,val)}this[_data][v]=val}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally {try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally {if(_didIteratorError4){throw _iteratorError4}}}}},{key:'_addHistory',value:function _addHistory(title,view_url){var tit='DARIAH contribution tool';var this_url=app_url+'?'+this.getVars(false);History.pushState(this[_data],tit,this_url)}},{key:'setState',value:function setState(v,val){this[_data][v]=val;g.localstorage_vars.set(v,val);this._addHistory()}},{key:'getState',value:function getState(v){return this[_data][v]}},{key:'getValues',value:function getValues(v){return this[_specs].get(v).vals}},{key:'showState',value:function showState(v,val,mode){var result=val;var md=mode==undefined?'sg':mode;var showas=this[_specs].get(v).showas;if(showas.has(val)){result=showas.get(val)[mode]}return result}},{key:'work',value:function work(){return function(){var state=History.getState();if(state&&state.data){this[_data]=state.data;this.page.work()}}.bind(this)}}]);return _class}();exports.default=_class;