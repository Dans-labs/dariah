'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally {try{if(!_n&&_i['return'])_i['return']()}finally {if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else {throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value' in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _generic=require('./generic.js');var g=_interopRequireWildcard(_generic);var _message=require('./message');var _message2=_interopRequireDefault(_message);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else {var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var _stage=Symbol();var _msg=Symbol();var _ids_fetched=Symbol();var _class=function(){function _class(name,specs,page){_classCallCheck(this,_class);this.name=name;this.page=page;this.specs=specs;this.variants=specs.variants;this[_stage]=new Map;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.variants[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var vr=_step.value;this[_stage].set(vr,new Map);var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.page.stages.keys()[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var st=_step2.value;this[_stage].get(vr).set(st,true)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally {if(_didIteratorError2){throw _iteratorError2}}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally {if(_didIteratorError){throw _iteratorError}}}this[_msg]=new Map;this[_ids_fetched]=new Set;this.container=new Map;this.dst=new Map;this.state=this.page.state;this.data=new Map;this.related_info=new Map;this.related_values=new Map;this.implementation=new specs.specific(this)}_createClass(_class,[{key:'need',value:function need(vr,stage){var promise=this[_stage].get(vr).get(stage);return !promise.state||promise.state()=='rejected'}},{key:'_deed',value:function _deed(vr,stage,method){var methodCall=this[method].bind(this,vr);var timing=this.page.getBefore(this.name,stage);var promises=[];var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=timing[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var _step3$value=_slicedToArray(_step3.value,2);var prev_name=_step3$value[0];var prev_stage=_step3$value[1];var prev_component=this.page.getComponent(prev_name);if(prev_component.hasVariant(vr)){promises.push(prev_component[_stage].get(vr).get(prev_stage))}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally {try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally {if(_didIteratorError3){throw _iteratorError3}}}this[_stage].get(vr).set(stage,$.when.apply($,promises).then(methodCall))}},{key:'ensure',value:function ensure(vr,stage,method){if(this.page.stages.has(stage)){var once=this.page.stages.get(stage)&&!this.specs.by_id;if(!once||this.need(vr,stage)){this._deed(vr,stage,method)}}}},{key:'hasVariant',value:function hasVariant(vr){return this.variants.has(vr)}},{key:'_visibility',value:function _visibility(vr,on){if(this.hasVariant(vr)){if(this.container.has(vr)){var widget=this.container.get(vr);if(on){widget.show()}else {widget.hide()}}}}},{key:'_fetch',value:function _fetch(vr,ids_to_fetch){var fetch_url=url_tpl.replace(/_c_/,'data').replace(/_f_/,this.specs.fetch_url+'_'+vr)+'.json';this[_msg].get(vr).msg('fetching data ...');var postFetch=this._postFetch.bind(this,vr);if(!(ids_to_fetch==undefined)){fetch_url+='?ids='+ids_to_fetch.join(',')}return $.ajax({type:'POST',url:fetch_url,contentType:'application/json; charset=utf-8',dataType:'json'}).then(function(json){postFetch(json,ids_to_fetch)})}},{key:'_postFetch',value:function _postFetch(vr,json,ids_to_fetch){this[_msg].get(vr).clear();var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=json.msgs[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var m=_step4.value;this[_msg].get(vr).msg(m)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally {try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally {if(_didIteratorError4){throw _iteratorError4}}}if(json.good){if('data' in json){this.data.set(vr,json.data)}if('relinfo' in json){var r=new Map;var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=json.relinfo[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var x=_step5.value;r.set(x[0],new Set(x[1]))}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally {try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally {if(_didIteratorError5){throw _iteratorError5}}}this.related_info.set(vr,r)}if('relvals' in json){this.related_values.set(vr,new Map(json.relvals))}if(this.specs.by_id){var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=ids_to_fetch[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var i=_step6.value;this[_ids_fetched].add(i)}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally {try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally {if(_didIteratorError6){throw _iteratorError6}}}}}this.implementation.weld(vr)}},{key:'_weld',value:function _weld(vr){this.dst=this.page.getContainer(this.specs.dest,this.variants);if(!this.specs.by_id){this.container.set(vr,$('#'+this.name+'_'+vr));if(this.container.get(vr).length==0){var destination=this.dst.get(vr);destination.append('<div id="msg_'+this.name+'_'+vr+'"></div>');destination.append('<div id="'+this.name+'_'+vr+'" class="component"></div>');this.container.set(vr,$('#'+this.name+'_'+vr))}this[_msg].set(vr,new _message2.default('msg_'+this.name+'_'+vr))}else {if(!this[_msg].has(vr)){var _destination=this.dst.get(vr);_destination.prepend('<div id="msg_'+this.name+'_'+vr+'"></div>');this[_msg].set(vr,new _message2.default('msg_'+this.name+'_'+vr))}}if(this.specs.fetch_url!=null){var ids_to_fetch=[];if(this.specs.by_id){var ids_asked_for=g.from_str(this.state.getState(this.specs.fetch_url+'_'+vr));var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=ids_asked_for[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var i=_step7.value;if(!this[_ids_fetched].has(i)){ids_to_fetch.push(i)}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally {try{if(!_iteratorNormalCompletion7&&_iterator7.return){_iterator7.return()}}finally {if(_didIteratorError7){throw _iteratorError7}}}if(ids_to_fetch.length!=0){return this._fetch(vr,ids_to_fetch)}}else {return this._fetch(vr)}}else {this.implementation.weld(vr)}}},{key:'_wire',value:function _wire(vr){this.implementation.wire(vr)}},{key:'_work',value:function _work(vr){this._visibility(vr,true);this.implementation.work(vr)}},{key:'weld',value:function weld(vr){if(this.hasVariant(vr)&&this.implementation.show(vr)){this.ensure(vr,'weld','_weld')}}},{key:'wire',value:function wire(vr){if(this.hasVariant(vr)&&this.implementation.show(vr)){this.ensure(vr,'wire','_wire')}}},{key:'work',value:function work(vr){if(this.hasVariant(vr)&&this.implementation.show(vr)){this.ensure(vr,'work','_work')}else {this._visibility(vr,false)}}}]);return _class}();exports.default=_class;