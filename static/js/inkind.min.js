 function Component(dst,name,fetch,source,specific,page){this._dst=$(`#${dst}`);this._loaded=false;this.name=name;this.page=page;this.state=page.state;if(fetch !=null){this._fetch_url=url_tpl.replace(/_c_/,`data`).replace(/_f_/,fetch)+`.json`;this.data=null;}else{this._fetch_url=null;this.data=source;}this.specific=new specific(this);};Component.prototype={_loaded:null,_fetch:function(){var that=this;if(this._fetch_url !=null){this.msg.msg(`fetching data ...`);$.post(this._fetch_url,{},function(json){that._loaded=true;that.msg.clear();json.msgs.forEach(function(m){that.msg.msg(m);});if(json.good){that.data=json.data;that._process();}},`json`);}else{this._process();}},_process:function(){this.specific.process();this.specific.apply();this.page.apply(this.name);},init:function(){this.container=$(`#${this.name}`);if(this.container.length==0){this._dst.append(`<div id="msg_${this.name}"></div>`);this._dst.append(`<div id="${this.name}"></div>`);this.container=$(`#${this.name}`);}this.msg=new Msg(`msg_${this.name}`);this._loaded=false;},apply:function(){if(this.specific.show()){this.container.show();if(!this._loaded){this._fetch();}else{this.specific.apply();this.page.apply(this.name);}}else{this.container.hide();}},};function Filters(comp){this.comp=comp};Filters.prototype={_html:function(){var h=``;for(var itm in this.comp.data){h +=`<div class="flt" lst="${itm}"><p>Filters for ${this.comp.state.showstate('list', itm, 'pl')}</p>`;h +=`<div class="ui-widget"><label for="flt_${itm}">title matches: </label><input id="flt_${itm}"/></div></div>`;}this.comp.container.html(h);},_dressup:function(){},show:function(){return true;},process:function(){this._html();this._dressup();},apply:function(){var that=this;var tags={};for(var itm in this.comp.data){var fdiv=this.comp.container.find(`div[lst="${itm}"]`);if(itm==this.comp.state.getstate(`list`)){var data=this.comp.page.getcomp(itm).data;tags[itm]=[];for(var i in data){var term=data[i][1];if(term !=null && term !=''){tags[itm].push(data[i][1]);}}this.comp.container.find(`#flt_${itm}`).autocomplete({source:tags[itm]});fdiv.show();}else{fdiv.hide();}}},};var escapeHTML=(function(){`use strict`;var chr={'&':`&amp;`,'<':`&lt;`,'>':`&gt;`};return function(text){return text.replace(/[&<>]/g,function(a){return chr[a];});};}());var Request={parameter:function(name){return this.parameters()[name];},parameters:function(uri){var i,parameter,params,query,result;result={};if(!uri){uri=window.location.search;}if(uri.indexOf("?")===-1){return{};}query=uri.slice(1);params=query.split("&");i=0;while(i < params.length){parameter=params[i].split("=");result[parameter[0]]=parameter[1];i++;}return result;}};var rvars=Request.parameters();var nslvars=$.initNamespaceStorage(`req`);var lvars=nslvars.localStorage;function List_contrib(comp){this.comp=comp};List_contrib.prototype={_html:function(){var h=``;h +=`<table id="table_${this.comp.name}">`;for(var i in this.comp.data){r=this.comp.data[i];h +=`<tr><td class="cc">${r[2]}<td><td class="cn">${r[3]}<td><td><a href="#" cid="${r[0]}">${r[1]}</a></td></tr>`;}h +=`</table>`;this.comp.container.html(h);},show:function(){return this.comp.state.getstate('list')==this.comp.name;},process:function(){this._html();},apply:function(){},};function List_country(comp){this.comp=comp};List_country.prototype={_html:function(){var h=``;h +=`<table id="table_${this.comp.name}">`;for(var i in this.comp.data){r=this.comp.data[i];h +=`<tr><td class="cc">${r[0]}<td><td class="cn">${r[1]}<td></tr>`;}h +=`</table>`;this.comp.container.html(h);},show:function(){return this.comp.state.getstate('list')==this.comp.name;},process:function(){this._html();},apply:function(){},};var List={contrib:List_contrib,country:List_country,};function Lists(comp){this.comp=comp};Lists.prototype={_html:function(){var h=``;for(var itm in this.comp.data){h +=`<a class="ctrl radio" href="#" itm="${itm}">${this.comp.state.showstate('list', itm, 'sg')}</a> `;}this.comp.container.html(h);},_dressup:function(){var that=this;this.comp.container.find(`.radio`).each(function(){$(this).click(function(e){e.preventDefault();that.comp.state.setstate(`list`,$(this).attr(`itm`));})})},show:function(){return true;},process:function(){this._html();this._dressup();},apply:function(){this.comp.container.find(`.radio`).removeClass(`ison`);this.comp.container.find(`a[itm="${this.comp.state.getstate('list')}"]`).addClass(`ison`);}};$(function(){(new Page()).apply()});function Msg(dst,on_clear){var that=this;this._dst=$(`#${dst}`);this._trashc=$(`#trash_${dst}`);this._trashp=this._trashc.closest(`p`);this._trashc.click(function(e){e.preventDefault();that.clear();});this._hide();this._on_clear=on_clear;};Msg.prototype={_hide:function(){this._dst.hide();this._trashp.hide();},_show:function(){this._dst.show();if(this._dst.html()!=``){this._trashp.show();}},clear:function(){this._dst.html(``);if(this._on_clear !=undefined){this._on_clear();}this._hide();},msg:function(text,kind){if(kind==undefined){kind=`info`;}var mtext=this._dst.html();this._dst.html(`${mtext}<p class="${kind}">${text}</p>`);this._show();},};function Page(){this.name='page';this.msg=new Msg(`msg_${this.name}`);this.state=new ViewState(this);var main_lists=this.state.getvalues('list');this._components=[['left','lists',null,main_lists,Lists],['left','filters',null,main_lists,Filters],];this._compindex={};this._routing={page:['lists'],};for(ml in main_lists){this._components.push(['middle',ml,ml,null,List[ml]]);this._routing['page'].push(ml);this._routing[ml]=[];this._routing[ml].push('filters');}this._init();};Page.prototype={_init:function(){this._compindex={};for(var i in this._components){var c=this._components[i];var co=new Component(c[0],c[1],c[2],c[3],c[4],this);this._compindex[c[1]]=co;co.init();}History.Adapter.bind(window,`statechange`,this.state.adapt(this.state));},getcomp:function(name){return this._compindex[name];},apply:function(cname){var comp=(cname==undefined)?'page':cname;if(this._routing[comp]!=undefined){for(var i in this._routing[comp]){var oname=this._routing[comp][i];this._compindex[oname].apply();}}},};function ViewState(page){this._data={};this._init();this.page=page;this.msg=page.msg;};ViewState.prototype={_specs:{list:{type:`string`,values:{contrib:1,country:1},def:`contrib`},greet:{type:`string`,values:null,def:`hallo`},id:{type:`integer`,values:{min:-1,max:1000000},def:0},sort:{type:`boolean`,values:{v:true,x:false},def:true},},_showas:{list:{contrib:{sg:'contribution',pl:'contributions'},country:{sg:'country',pl:'countries'},},},_validate:function(name,val){var newval,message;if(name in this._specs){var s=this._specs[name];if(s.type==`string`){if(s.values){if(val in s.values){newval=val;}else{newval=s.def;this.msg.msg(`illegal string value for ${name}: "${val}" is replaced by "${s.def}"`,`warning`);}}else{newval=val;}}else if(s.type==`integer`){if(/^(\-|\+)?[0-9]+$/.test(val)){newval=Number(val);}else{newval=s.def;this.msg.msg(`not a number value for ${name}: "${val}" is replaced by "${s.def}"`,`warning`);}}else if(s.type==`boolean`){if(val in s.values){newval=s.values[val];}else{newval=s.def;this.msg.msg(`illegal boolean value for ${name}: "${val}" is replaced by "${s.def}"`,`warning`);}}}else{newval=null;this.msg.msg(`unknown parameter: ${name}=${val}`,`warning`);}return newval;},_getvars:function(){vars=[];for(var name in this._data){var val=this._data[name];var spec=this._specs[name];if(spec.type==`string` || spec.type==`integer`){vars.push(`${name}=${val}`)}else if(spec.type==`boolean`){for(z in spec.values){if(spec.values[z]==val){vars.push(`${name}=${z}`)}}}}return vars.join('&')},_getinitstate:function(){for(var name in rvars){if(!(name in this._specs)){this.msg.msg(`unknown parameter: ${name}=${val}`,`warning`);}}for(var name in this._specs){var val=null;if(name in rvars){var raw_val=rvars[name];val=this._validate(name,raw_val);lvars.set(name,val);}else if(lvars.isSet(name)){val=lvars.get(name);}else{val=this._specs[name].def;lvars.set(name,val);}this._data[name]=val;}},_addHist:function(title,view_url){var tit=`DARIAH contribution tool`;var this_url=`${app_url}?${this._getvars()}`;History.pushState(this._data,tit,this_url);},_init:function(){this._getinitstate();this._addHist();},setstate:function(name,val){this._data[name]=val;lvars.set(name,val);this._addHist();},getstate:function(name){return this._data[name];},getvalues:function(name){return this._specs[name].values;},showstate:function(name,val,mode){var result=val;var md=(mode==undefined)?`sg`:mode;if(this._showas[name]!=undefined && this._showas[name][val]!=undefined){result=this._showas[name][val][mode];}return result;},adapt:function(ob){return function(){var state=History.getState();if(state && state.data){ob._data=state.data;ob.page.apply();}}},};