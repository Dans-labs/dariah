/* GENERIC
 * Some function for very generic purposes
 */

var ºescapeHTML = (function () {
    `use strict`;
    var ºchr = {
        '&': `&amp;`, '<': `&lt;`,  '>': `&gt;`
    };
    return function (ºtext) {
        return ºtext.replace(/[&<>]/g, function (ºa) { return ºchr[ºa]; });
    };
}());

var ºRequest = {
    ºparameter: function(ºname) {
        return this.ºparameters()[ºname];
    },
    ºparameters: function(ºuri) {
        var ºi, ºparameter, ºparams, ºquery, ºresult;
        ºresult = {};
        if (!ºuri) {
            ºuri = window.location.search;
        }
        if (ºuri.indexOf("?") === -1) {
            return {};
        }
        ºquery = ºuri.slice(1);
        ºparams = ºquery.split("&");
        ºparams.forEach(function(ºp, ºi) {
            ºparameter = ºp.split("=");
            ºresult[ºparameter[0]] = ºparameter[1];
        });
        return ºresult;
    }
};

var ºrequest_vars = ºRequest.ºparameters();
var ºlocalstorage = $.initNamespaceStorage(`req`);
var ºlocalstorage_vars = ºlocalstorage.localStorage;


/* MESSAGES
 * ºMsg is a function that issues messages to a specified element.
 * It has also controls for clearing and hiding the messages.
 */

function ºMsg(ºdestination, ºon_clear) {
    this.º_destination = $(`#${ºdestination}`);
    this.º_trash_control = $(`#trash_${ºdestination}`);
    this.º_trash_control_para = this.º_trash_control.closest(`p`);
    this.º_trash_control.click(function(ºe) {ºe.preventDefault();
        this.ºclear();
    }.bind(this));
    this.º_hide();
    this.º_on_clear = ºon_clear;
};

ºMsg.prototype = {
    º_hide: function() {
        this.º_destination.hide();
        this.º_trash_control_para.hide();
    },
    º_show: function() {
        this.º_destination.show();
        if (this.º_destination.html() != ``) {
            this.º_trash_control_para.show();
        }
    },
    ºclear: function() {
        this.º_destination.html(``);
        if (this.º_on_clear != undefined) {
            this.º_on_clear();
        }
        this.º_hide();
    },
    ºmsg: function(ºtext, ºkind) {
        if (ºkind == undefined) {
            ºkind = `info`;
        }
        var ºmessage_text = this.º_destination.html();
        this.º_destination.html(`${ºmessage_text}<p class="${ºkind}">${ºtext}</p>`);
        this.º_show();
    },
};


/* VIEW STATE
 * Contains the current state, based on request variables and local storage.
 * Request variables have precedence over local storage.
 * Request variables are checked and validated and translated, translated ºvalues go to local storage.
 * There is a list of recognized request variables, with their ºtypes and allowable ºvalues.
 */

function ºViewState(ºpage) {
    this.º_data = {};
    this.ºpage = ºpage;
    this.ºmsg = ºpage.ºmsg;
    this.º_getInitstate();
    this.º_addHistory();
};

ºViewState.prototype = {
    º_specs: {
        list: {ºurl: true, ºtype: `string`, ºvalues: {contrib: 1, country: 1, type: 1, tadiraha: 1, tadiraho: 1, tadiraht: 1}, ºdefault_value: `contrib`},
        flt_contrib: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        flt_country: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        flt_type: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        flt_tadiraha: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        flt_tadiraho: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        flt_tadiraht: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        rel_country_contrib: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        rel_type_contrib: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        rel_tadiraha_contrib: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        rel_tadiraho_contrib: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        rel_tadiraht_contrib: {ºurl: false, ºtype: `string`, ºvalues: null, ºdefault_value: ``},
        id: {ºurl: true, ºtype: `integer`, ºlimits: {ºmin: -1, ºmax: 1000000}, ºdefault_value: 0},
        sort: {ºurl: false, ºtype: `boolean`, ºvalues: {v: true, x: false}, ºdefault_value: true}, 
    },
    º_showas: {
        list: {
            contrib: {ºsg: `contribution`, ºpl: `contributions`},
            country: {ºsg: `country`, ºpl: `countries`},
            type: {ºsg: `type`, ºpl: `types`},
            tadiraha: {ºsg: `tadirah activity`, ºpl: `tadirah activities`},
            tadiraho: {ºsg: `tadirah object`, ºpl: `tadirah objects`},
            tadiraht: {ºsg: `tadirah technique`, ºpl: `tadirah techniques`},
        },
    },
    º_validate: function(ºname, ºval) {
        var ºnewval, ºmessage;
        if (ºname in this.º_specs) {
            var ºspec = this.º_specs[ºname];
            if (ºspec.ºtype == `string`) {
                if (ºspec.ºvalues) {
                    if (ºval in ºspec.ºvalues) {
                        ºnewval = ºval;
                    }
                    else {
                        ºnewval = ºspec.ºdefault_value;
                        this.ºmsg.ºmsg(`illegal string value for ${ºname}: "${ºval}" is replaced by "${ºspec.ºdefault_value}"`, `warning`);
                    }
                }
                else {
                    ºnewval = ºval;
                }
            }
            else if (ºspec.ºtype == `integer`) {
                if (/^(\-|\+)?[0-9]+$/.test(ºval)) {
                    ºnewval = Number(ºval);
                }
                else {
                    ºnewval = ºspec.ºdefault_value;
                    this.ºmsg.ºmsg(`not a number value for ${ºname}: "${ºval}" is replaced by "${ºspec.ºdefault_value}"`, `warning`);
                }
                if (ºnewval < ºspec.ºlimits.ºmin) {
                    this.ºmsg.ºmsg(`number to small for ${ºname}: "${ºnewval}" is replaced by "${ºspec.ºlimits.ºmin}"`, `warning`);
                }
                if (ºnewval > ºspec.ºlimits.ºmax) {
                    this.ºmsg.ºmsg(`number to big for ${ºname}: "${ºnewval}" is replaced by "${ºspec.ºlimits.ºmax}"`, `warning`);
                }
            }
            else if (ºspec.ºtype == `boolean`) {
                if (ºval in ºspec.ºvalues) {
                    ºnewval = ºspec.ºvalues[ºval];
                }
                else {
                    ºnewval = ºspec.ºdefault_value;
                    this.ºmsg.ºmsg(`illegal boolean value for ${ºname}: "${ºval}" is replaced by "${ºspec.ºdefault_value}"`, `warning`);
                }
            }
        }
        else {
            ºnewval = null;
            this.ºmsg.ºmsg(`unknown parameter: ${ºname}=${ºval}`, `warning`);
        }
        return ºnewval;
    },
    º_getVars: function() {
        ºvars = [];
        for (var ºname in this.º_data) {
            var ºval = this.º_data[ºname];
            var ºspec = this.º_specs[ºname];
            if (ºspec.ºurl) {
                if (ºspec.ºtype == `string` || ºspec.ºtype == `integer`) {ºvars.push(`${ºname}=${ºval}`)}
                else if (ºspec.ºtype == `boolean`) {
                    for (var ºvalid_val in ºspec.ºvalues) {
                        if (ºspec.ºvalues[ºvalid_val] == ºval) {ºvars.push(`${ºname}=${ºvalid_val}`)}
                    }
                }
            }
        }
        return ºvars.join(`&`)
    },
    º_getInitstate: function() {
        for (var ºname in ºrequest_vars) {
            if (!(ºname in this.º_specs)) {
                this.ºmsg.ºmsg(`unknown parameter: ${ºname}=${ºval}`, `warning`);
            }
        }
        for (var ºname in this.º_specs) {
            var ºval = null;
            if (ºname in ºrequest_vars) {
                var ºraw_val = ºrequest_vars[ºname];
                ºval = this.º_validate(ºname, ºraw_val);
                ºlocalstorage_vars.set(ºname, ºval);
            }
            else if (ºlocalstorage_vars.isSet(ºname)) {
                ºval = ºlocalstorage_vars.get(ºname);
            }
            else {
                ºval = this.º_specs[ºname].ºdefault_value;
                ºlocalstorage_vars.set(ºname, ºval);
            }
            this.º_data[ºname] = ºval;
        }
    },
    º_addHistory: function(ºtitle, ºview_url) {
        var ºtit = `DARIAH contribution tool`;
        var ºthis_url = `${app_url}?${this.º_getVars()}`;
        History.pushState(this.º_data, ºtit, ºthis_url);
    },
    ºsetState: function(ºname, ºval) {
        this.º_data[ºname] = ºval;
        ºlocalstorage_vars.set(ºname, ºval);
        this.º_addHistory();
    },
    ºgetState: function(ºname) {
        return this.º_data[ºname];
    },
    ºgetValues: function(ºname) {
        return this.º_specs[ºname].ºvalues;
    },
    ºshowState: function(ºname, ºval, ºmode) {
        var ºresult = ºval;
        var ºmd = (ºmode == undefined)?`ºsg`:ºmode;
        if (this.º_showas[ºname] != undefined && this.º_showas[ºname][ºval] != undefined) {
            ºresult = this.º_showas[ºname][ºval][ºmode];
        }
        return ºresult;
    },
    ºwork: function() {
        return function () {
            var ºstate = History.getState();
            if (ºstate && ºstate.data) {
                this.º_data = ºstate.data;
                this.ºpage.ºwork();
            }
        }.bind(this)
    },
};


/* INDIVIDUAL COMPONENT: generic facet based on related values
 * CType, Tadiraho and EUmap inherit from this.
 */

function ºRelative(ºcomponent, ºtype) {
    this.ºcomponent = ºcomponent;
    this.ºdistilled = {};
    this.º_list = {};
    this.º_list2 = {};
    this.º_related_state = {};
    this.º_all_values_control = {};
    this.º_statistics = {};
    this.º_related_values_list = {};
    this.º_related_values_index = {};
    this.º_related_values_on = {};
    this.º_related_values_off = {};
    this.º_no_values = {ºvalue: `-`, ºname: `-none`};
    this.º_type = ºtype;
};

ºRelative.prototype = {
    º_html: function(ºvar) {
        var ºcols = 2;
        var ºtype_sg = this.ºcomponent.ºstate.ºshowState(`list`, this.º_type, `ºsg`);
        var ºtype_pl = this.ºcomponent.ºstate.ºshowState(`list`, this.º_type, `ºpl`);
        var ºh = `<div><p class="•dctrl">By ${ºtype_sg}</p>`;
        ºh += this.º_myHtml(ºvar);
        ºh += `<p class="•all"><span rv="_all" class="•stats"></span> <a rv="_all" href="#" class="•control_med">all ${ºtype_pl}</a></p>
<table class="•value_list" id="list-${this.º_type}-vals_${ºvar}"><tr>`;
        this.º_related_values_list[ºvar].forEach(function(ºrelated_value, ºi, ºar) {
            if ((ºi % ºcols == 0) && (ºi > 0) && (ºi < ºar.length)) {
                ºh += `</tr><tr>`;
            }
            ºh += `<td><span rv="${ºrelated_value}" class="•stats"></span></td><td><a rv="${ºrelated_value}" href="#" class="•control_small">${this.º_related_values_index[ºvar][ºrelated_value]}</a></td>`;
        }, this);
        ºh += `</tr></table>`;
        ºh += `<p class="•value_list2" id="list2-${this.º_type}-vals_${ºvar}">`;
        this.º_related_values_list[ºvar].forEach(function(ºrelated_value, ºi, ºar) {
            ºh += `<span rv="${ºrelated_value}" class="•passive_small">${this.º_related_values_index[ºvar][ºrelated_value]}</span> `;
        }, this);
        ºh += `</p>`;
        ºh += `</div>`;
        this.ºcomponent.ºcontainer[ºvar].html(ºh);
    },
    º_dressup: function(ºvar) {
        var ºcc = this.ºcomponent.ºcontainer[ºvar];
        this.º_list[ºvar] = ºcc.find(`#list-${this.º_type}-vals_${ºvar}`);
        this.º_list2[ºvar] = ºcc.find(`#list2-${this.º_type}-vals_${ºvar}`);
        var ºthat = this;
        this.º_list[ºvar].find(`.•control_small`).click(function(ºe) {ºe.preventDefault();
            var ºrelated_value = $(this).attr(`rv`);
            var ºselected = ºthat.º_from_str(ºvar, ºthat.ºcomponent.ºstate.ºgetState(`rel_${ºthat.º_type}_${ºvar}`));
            ºselected[ºrelated_value] = (ºrelated_value in ºselected)?!ºselected[ºrelated_value]:true;
            ºthat.ºcomponent.ºstate.ºsetState(`rel_${ºthat.º_type}_${ºvar}`, ºthat.º_to_str(ºselected));
        });
        this.º_all_values_control[ºvar] = this.ºcomponent.ºcontainer[ºvar].find(`[rv="_all"]`);
        this.º_all_values_control[ºvar].click(function(ºe) {ºe.preventDefault();
            var ºison = $(this).hasClass(`•ison`);
            if (ºison) {
                ºthat.ºcomponent.ºstate.ºsetState(`rel_${ºthat.º_type}_${ºvar}`, ºthat.º_to_str(ºthat.º_related_values_off[ºvar]));
            }
            else {
                ºthat.ºcomponent.ºstate.ºsetState(`rel_${ºthat.º_type}_${ºvar}`, ºthat.º_to_str(ºthat.º_related_values_on[ºvar]));
            }
        });
    },
    º_setFacet: function(ºvar, ºrelated_values) {
        var ºall_selected = true;
        for (var ºrelated_value in this.º_related_values_index[ºvar]) {
            var ºfacet_cell = this.º_list[ºvar].find(`[rv="${ºrelated_value}"]`);
            var ºfacet_cell2 = this.º_list2[ºvar].find(`[rv="${ºrelated_value}"]`);
            if (ºrelated_value in ºrelated_values && ºrelated_values[ºrelated_value]) {
                ºfacet_cell.addClass(`•ison`);
                ºfacet_cell2.addClass(`•ison`);
            }
            else {
                ºfacet_cell.removeClass(`•ison`);
                ºfacet_cell2.removeClass(`•ison`);
                ºall_selected = false;
            }
        }
        if (ºall_selected) {
            this.º_all_values_control[ºvar].addClass(`•ison`);
        }
        else {
            this.º_all_values_control[ºvar].removeClass(`•ison`);
        }
    },
    º_a_to_str: function(ºar) {
        return ºar.join(',');
    },
    º_to_str: function(ºob) {
        var ºar = [];
        for (var ºx in ºob) {
            if (ºob[ºx]) {
                ºar.push(ºx);
            }
        }
        return ºar.join(',');
    },
    º_from_str: function(ºvar, ºst) {
        var ºob = {};
        if (ºst !== null && ºst != undefined && ºst != '') {
            var ºar = ºst.split(',');
            ºar.forEach(function(ºv) {
                ºob[ºv] = true;
            });
        }
        for (var ºrelated_value in this.º_related_values_index[ºvar]) {
            if (!(ºrelated_value in ºob)) {
                ºob[ºrelated_value] = false;
            }
        }
        return ºob;
    },
    ºstats: function(ºvar) {
        this.º_statistics[ºvar] = {};
        for (var ºrelated_value in this.º_related_values_index[ºvar]) {
            this.º_statistics[ºvar][ºrelated_value] = 0;
        } 
        var ºrelated_data = this.ºcomponent.ºdata[ºvar];
        for (var ºx in this.ºdistilled[ºvar]) {
            var ºi = this.ºdistilled[ºvar][ºx];
            var ºhas_related_value = false;
            for (var ºrelated_value in ºrelated_data[ºi]) {
                this.º_statistics[ºvar][ºrelated_value] += 1;
                ºhas_related_value = true;
            }
            if (!ºhas_related_value) {
                this.º_statistics[ºvar][this.º_no_values.ºvalue] += 1;
            }
        }
        for (var ºrelated_value in this.º_statistics[ºvar]) {
            this.ºcomponent.ºcontainer[ºvar].find(`span[rv="${ºrelated_value}"].•stats`).html(this.º_statistics[ºvar][ºrelated_value]);
        }
        this.ºcomponent.ºcontainer[ºvar].find(`span[rv="_all"].•stats`).html(this.ºdistilled[ºvar].length);
        this.º_myStats(ºvar);
    },
    ºv: function(ºvar, ºi) {
        var ºrelated_data =  this.ºcomponent.ºdata[ºvar];
        var ºrelated_state = this.º_from_str(ºvar, this.º_related_state[ºvar]);
        if ((ºi in ºrelated_data) && (Object.keys(ºrelated_data[ºi]).length != 0)) {
            for (var ºrelated_value in ºrelated_data[ºi]) {
                if ((ºrelated_value in ºrelated_state) && ºrelated_state[ºrelated_value]) {
                    return true;
                }
            }
        }
        else {
            if ((this.º_no_values.ºvalue in ºrelated_state) && (ºrelated_state[this.º_no_values.ºvalue])) {
                return true;
            }
        }
        return false;
    },
    ºshow: function(ºvar) {
        return (this.ºcomponent.ºstate.ºgetState(`list`) == ºvar);
    },
    ºweld: function(ºvar) {
        this.º_related_values_list[ºvar] = [];
        this.º_related_values_index[ºvar] = {};
        this.º_related_values_off[ºvar] = {};
        this.º_related_values_on[ºvar] = {};
        this.º_plainWeld(ºvar);
        this.º_myWeld(ºvar);
        this.º_related_values_list[ºvar].push(this.º_no_values.ºvalue);
        this.º_related_values_index[ºvar][this.º_no_values.ºvalue] = this.º_no_values.ºname;
        this.º_related_values_off[ºvar][this.º_no_values.ºvalue] = false;
        this.º_related_values_on[ºvar][this.º_no_values.ºvalue] = true;
        this.º_html(ºvar);
    },
    ºwire: function(ºvar) {
        this.º_myDressup(ºvar);
        this.º_dressup(ºvar);
    },
    ºwork: function(ºvar) {
        this.º_related_state[ºvar] = this.ºcomponent.ºstate.ºgetState(`rel_${this.º_type}_${ºvar}`);
        var ºrelated_values =  this.º_from_str(ºvar, this.º_related_state[ºvar]);
        this.º_mySetFacet(ºvar, ºrelated_values);
        this.º_setFacet(ºvar, ºrelated_values);
    },
    º_plainWeld: function(ºvar) {
        var ºrelated_values = this.ºcomponent.ºrelated_values[ºvar];
        for (var ºi in ºrelated_values) {
            var ºrelated_value = ºrelated_values[ºi];
            this.º_related_values_off[ºvar][ºi] = false;
            this.º_related_values_on[ºvar][ºi] = true;
            this.º_related_values_list[ºvar].push(ºi);
            this.º_related_values_index[ºvar][ºi] = ºrelated_value;
        }
        this.º_related_values_list[ºvar].sort(function(ºa,ºb) {
            return (ºrelated_values[ºa] < ºrelated_values[ºb])?-1:(ºrelated_values[ºa] > ºrelated_values[ºb])?1:0; 
        });
    },
    º_myWeld: function(ºvar) {},
    º_myHtml: function(ºvar) {return ``},
    º_myDressup: function(ºvar) {},
    º_mySetFacet: function(ºvar) {},
    º_myStats: function(ºvar) {},
};

/* INDIVIDUAL COMPONENT: ctype
 * This manages the facet "contribution type"
 */

function ºCType(ºcomponent) {
    ºRelative.call(this, ºcomponent, `type`);
};

ºCType.prototype = Object.create(ºRelative.prototype);
ºCType.prototype.constructor = ºCType;

/* INDIVIDUAL COMPONENT: ctype
 * This manages the facet "contribution type"
 */

function ºTadirahO(ºcomponent) {
    ºRelative.call(this, ºcomponent, `tadiraho`);
};

ºTadirahO.prototype = Object.create(ºRelative.prototype);
ºTadirahO.prototype.constructor = ºTadirahO;

/* INDIVIDUAL COMPONENT: ctype
 * This manages the facet "contribution type"
 */

function ºTadirahA(ºcomponent) {
    ºRelative.call(this, ºcomponent, `tadiraha`);
};

ºTadirahA.prototype = Object.create(ºRelative.prototype);
ºTadirahA.prototype.constructor = ºTadirahA;

/* INDIVIDUAL COMPONENT: ctype
 * This manages the facet "contribution type"
 */

function ºTadirahT(ºcomponent) {
    ºRelative.call(this, ºcomponent, `tadiraht`);
};

ºTadirahT.prototype = Object.create(ºRelative.prototype);
ºTadirahT.prototype.constructor = ºTadirahT;

/* INDIVIDUAL COMPONENT: ºEUmap
 * This manages a clickable map of the EU ºcountries
 * See http://jvectormap.com/documentation/javascript-api/jvm-map/
 */

function ºEUmap(ºcomponent) {
    ºRelative.call(this, ºcomponent, `country`);
    this.º_map_object = {};
    this.º_map_container = {};
    this.º_marker = {};
    this.º_setvalues = {};
    this.º_not_mapped = {
        CY: true,
        KS: true,
        TR: true,
        MC: true,
        GE: true,
    };
}
ºEUmap.prototype = Object.create(ºRelative.prototype);
ºEUmap.prototype.constructor = ºEUmap;
ºEUmap.prototype.º_myHtml = function(ºvar) {
    return `<div id="map-europe_${ºvar}" class="•position"><p class="•zoom"><a class="fa fa-arrows" href="#" title="zoom to fit all countries"/></p></div>`;
};
ºEUmap.prototype.º_myDressup = function(ºvar) {
    var ºthat = this;
    var ºcc = this.ºcomponent.ºcontainer[ºvar];
    this.º_map_container[ºvar] = ºcc.find(`#map-europe_${ºvar}`);
    var ºheight = this.º_map_container[ºvar].width()*0.6;
    this.º_map_container[ºvar].width(`100%`);
    this.º_map_container[ºvar].height(ºheight);
    this.º_map_container[ºvar].vectorMap({
        'map': `europe_mill`,
        backgroundColor: `#ccccff`,
        regionsSelectable: true,
        markersSelectable: true,
        regionsSelectableOne: false,
        markersSelectableOne: false,
        markerStyle: {
            initial: {
                fill: `#008800`,
                'fill-opacity': 0.2,
                stroke: `none`,
                'stroke-width': 0,
                'stroke-opacity': 0.2,
                'r': 1,
            },
            hover: {
                cursor: `pointer`,
                stroke: `#ffff44`,
                'stroke-width': 1,
                'stroke-opacity': 1,
            },
            selected: {
                fill: `#008800`,
                'fill-opacity': 1,
            },
            selectedHover: {
            },
        },
        regionStyle: {
            initial: {
                fill: `#bbbbbb`,
                'fill-opacity': 1,
                stroke: `none`,
                'stroke-width': 0,
                'stroke-opacity': 1,
            },
            hover: {
                cursor: `pointer`,
                stroke: `#ffff44`,
                'stroke-width': 3,
                'stroke-opacity': 1,
            },
            selected: {
                fill: `#dd8844`,
                'fill-opacity': 1,
            },
            selectedHover: {
            },
        },
        markers: this.º_marker[ºvar],
        series: {
            markers: [{
                values: {},
                    scale: [0,20],
                    normalizeFunction: `linear`,
                    attribute: `r`,
                    min: 0,
                    max: 100,
            }],
            regions: [{
                    scale: {
                        'ºoutdariah': `#ffffff`,
                        'ºindariah': `#ffddbb`,
                    },
                    attribute: `fill`,
                    values: this.º_setvalues[ºvar],
            }],
        },
        onRegionTipShow: function(ºe, ºel, ºrelated_value) {
            ºel.html(`${ºrelated_value}: ${(ºrelated_value in this.º_statistics[ºvar])?this.º_statistics[ºvar][ºrelated_value]:'not in DARIAH'}`);
        }.bind(this),
        onMarkerTipShow: function(ºe, ºel, ºrelated_value) {
            ºel.html(`${ºrelated_value}: ${(ºrelated_value in this.º_statistics[ºvar])?this.º_statistics[ºvar][ºrelated_value]:'not in DARIAH'}`);
        }.bind(this),
        onRegionClick: function(ºe, ºrelated_value) {
            if (!(ºrelated_value in this.º_related_values_index[ºvar])) {
                ºe.preventDefault();
            }
        }.bind(this),
        onMarkerClick: function(ºe, ºrelated_value) {
            if (!(ºrelated_value in this.º_related_values_index[ºvar])) {
                ºe.preventDefault();
            }
        }.bind(this),
        onRegionSelected: function(ºe, ºrelated_value, ºi, ºselected) {
            if (this.ºchange_state) {
                this.ºcomponent.ºstate.ºsetState(`rel_${this.º_type}_${ºvar}`, this.º_a_to_str(ºselected));
            }
        }.bind(this),
        onMarkerSelected: function(ºe, ºrelated_value, ºi, ºselected) {
            if (this.ºchange_state) {
                this.ºcomponent.ºstate.ºsetState(`rel_${this.º_type}_${ºvar}`, this.º_a_to_str(ºselected));
            }
        }.bind(this),
    });
    var ºzoom_p = ºcc.find(`p.•zoom`);
    ºzoom_p.css(`top`, `${ºheight-20}px`);
    ºzoom_p.css(`left`, `10px`);
    var ºzoom_control = ºcc.find(`p.•zoom a`);
    ºzoom_control.click(function(ºe) {ºe.preventDefault();
        ºthat.º_map_object[ºvar].setFocus({regions: [`GB`, `GR`]});
    });
    this.º_map_object[ºvar] = this.º_map_container[ºvar].vectorMap('get', 'mapObject');
    this.º_map_object[ºvar].setFocus({regions: [`GB`, `GR`]});
};
ºEUmap.prototype.º_mySetFacet = function(ºvar, ºrelated_values) {
    this.ºchange_state = false;
    /* some countries are not on the map, we do ºshow those countries in the list but not on the map.
     * Same for -, the key that denotes ALL countries
     */
    var ºmap_regions = {};
    for (var ºrelated_value in ºrelated_values) {
        if (!(ºrelated_value in this.º_not_mapped) && ºrelated_value != this.º_no_values.ºvalue) {
            ºmap_regions[ºrelated_value] = ºrelated_values[ºrelated_value];
        }
    }
    this.º_map_object[ºvar].setSelectedRegions(ºmap_regions);
    this.º_map_object[ºvar].setSelectedMarkers(ºmap_regions);
    this.ºchange_state = true;
};
ºEUmap.prototype.º_myStats = function(ºvar) {
    var ºtotal = this.ºdistilled[ºvar].length;
    if (ºtotal == 0) {ºtotal = 1}
    var ºweighted_statistics = {};
    for (var ºrelated_value in this.º_statistics[ºvar]) {
        if (ºrelated_value != this.º_no_values.ºvalue) {
            var ºpr = 100 * this.º_statistics[ºvar][ºrelated_value] / ºtotal;
            ºweighted_statistics[ºrelated_value] = (ºtotal < 10)?ºpr:(10*Math.sqrt(ºpr));
        }
    }
    this.º_map_object[ºvar].series.markers[0].setValues(ºweighted_statistics);
};
ºEUmap.prototype.º_plainWeld = function(ºvar) {};
ºEUmap.prototype.º_myWeld = function(ºvar) {
    this.º_marker[ºvar] = {};
    this.º_setvalues[ºvar] = {};
    var ºrelated_values = this.ºcomponent.ºrelated_values[ºvar];
    for (var ºi in ºrelated_values) {
        var ºrelated_value = ºrelated_values[ºi];
        if (ºrelated_value[1]) {
            this.º_related_values_off[ºvar][ºi] = false;
            this.º_related_values_on[ºvar][ºi] = true;
            this.º_related_values_list[ºvar].push(ºi);
            this.º_related_values_index[ºvar][ºi] = ºrelated_value[0];
            if (ºrelated_value.length > 3) {
                this.º_marker[ºvar][ºi] = {latLng: [ºrelated_value[2], ºrelated_value[3]], ºname: ºrelated_value[0]};
            }
            this.º_setvalues[ºvar][ºi] = 'ºindariah';
        }
        else {
            this.º_setvalues[ºvar][ºi] = 'ºoutdariah';
        }
    }
    this.º_related_values_list[ºvar].sort(function(ºa,ºb) {
        return (ºrelated_values[ºa] < ºrelated_values[ºb])?-1:(ºrelated_values[ºa][0] > ºrelated_values[ºb][0])?1:0; 
    });
};

/* INDIVIDUAL COMPONENT: Filters
 * This is a list of filter controls corresponding to lists of records to be displayed in the middle column
 * Setting a filter control filters the associated list.
 */

function ºFilter(ºcomponent) {
    this.ºcomponent = ºcomponent;
    this.º_tags = {};
    this.º_filter_control = {};
    this.º_filter_control2 = {};
    this.º_box = {};
    this.º_completions_dst = {};
    this.º_stats_dst = {};
    this.º_clear_filter_control = {};
    this.º_wire_mode = {};
    this.º_distilled = {};
    this.ºdistilled = {};
};

ºFilter.prototype = {
    º_html: function(ºvar) {
        var ºh = `<div><p class="•dctrl">By full text search <span id="flt2_${ºvar}" class="•flt_compact"></span></p>`;
        ºh += `<div id="fltw_${ºvar}">`;
        ºh += `<p id="•fbox_${ºvar}" class="•flt •control_med •fbox ui-widget">`;
        ºh += `<input id="flt_${ºvar}" class="flt"/>`;
        ºh += `<a href="#" class="•control_med fa fa-close •filtc" id="clearf_${ºvar}"></a>`;
        ºh += `<span •fbox class="•stats" id="stats_${ºvar}"></span>&nbsp;`;
        ºh += `</p>`;
        ºh += `<div id="autoc_${ºvar}" style="display: none;">here ${ºvar}</div>`;
        ºh += `</div>`;
        this.ºcomponent.ºcontainer[ºvar].html(ºh);
    },
    º_setFacet: function(ºvar) {
        var ºtextf = this.ºcomponent.ºstate.ºgetState(`flt_${ºvar}`);
        this.º_filter_control2[ºvar].html(ºtextf);
        console.log(this.º_filter_control2[ºvar]);
        this.º_filter_control[ºvar].val(ºtextf);
        this.º_filter_control[ºvar].autocomplete(`search`, ºtextf);
    },
    º_response: function(ºvar) {
        return function(ºevent, ºui) {
            this.º_distilled[ºvar] = {};
            ºui.content.forEach(function(ºu, ºi) {
                this.º_distilled[ºvar][ºu.value] = 1;
            }, this);
            if (!(this.º_wire_mode[ºvar])) {
                this.ºcomponent.ºstate.ºsetState(`flt_${ºvar}`, this.º_filter_control[ºvar].val());
            }
        }.bind(this);
    },
    º_setClear: function(ºvar) {
        this.º_clear_filter_control[ºvar].click(function(ºe) {ºe.preventDefault();
            this.º_filter_control[ºvar].val(``);
            this.º_filter_control[ºvar].autocomplete(`search`, ``);
        }.bind(this));
    },
    ºstats: function(ºvar) {
        var ºstat_prefix;
        if (this.º_filter_control[ºvar].val() == ``) {
            ºstat_prefix = ``;
            this.º_stats_dst[ºvar].removeClass(`•ison`);
        }
        else {
            ºstat_prefix = `${this.ºfacet.ºdistilled[ºvar].length} of `;
            this.º_stats_dst[ºvar].addClass(`•ison`);
        }
        this.º_stats_dst[ºvar].html(`${ºstat_prefix}${this.ºdistilled[ºvar].length}`);
    },
    ºv: function(ºvar, ºi) {
        return (ºi in this.º_distilled[ºvar]);
    },
    ºshow: function(ºvar) {
        return (this.ºcomponent.ºstate.ºgetState(`list`) == ºvar);
    },
    ºweld: function(ºvar) {
        this.º_html(ºvar);
    },
    ºwire: function(ºvar) {
        if (!this.ºfacet) {
            this.ºfacet = this.ºcomponent.ºpage.ºgetComponent(`ºfacet`).ºimplementation;
        }
        var ºdata = this.ºcomponent.ºpage.ºgetComponent(`ºlist`).ºdata[ºvar];
        this.º_tags[ºvar] = [];
        ºdata.forEach(function(ºd, ºi) {
            this.º_tags[ºvar].push({label: ºd[1], value: `${ºd[0]}`});
        }, this);
        this.º_distilled[ºvar] = {};
        this.ºdistilled[ºvar] = [];
        var ºcc = this.ºcomponent.ºcontainer[ºvar];
        var ºcf = ºcc.find(`#fltw_${ºvar}`);
        this.º_filter_control[ºvar] = ºcf.find(`#flt_${ºvar}`);
        this.º_filter_control2[ºvar] = ºcc.find(`#flt2_${ºvar}`);
        this.º_box[ºvar] = ºcf.find(`#•fbox_${ºvar}`);
        this.º_completions_dst[ºvar] = ºcf.find(`#autoc_${ºvar}`);
        this.º_stats_dst[ºvar] = ºcf.find(`#stats_${ºvar}`);
        this.º_clear_filter_control[ºvar] = ºcf.find(`#clearf_${ºvar}`);
        this.º_filter_control[ºvar].autocomplete({
            appendTo: this.º_completions_dst[ºvar],
            source: this.º_tags[ºvar],
            response: this.º_response(ºvar),
            minLength: 0,
        });
        this.º_setClear(ºvar);
        this.º_wire_mode[ºvar] = true;
        this.º_setFacet(ºvar);
        this.º_wire_mode[ºvar] = false;
    },
    ºwork: function(ºvar) {
        var ºtextf = this.º_filter_control[ºvar].val();
        if (ºtextf == ``) {
            this.º_box[ºvar].removeClass(`•ison`);
            this.º_clear_filter_control[ºvar].hide();
        }
        else {
            this.º_box[ºvar].addClass(`•ison`);
            this.º_clear_filter_control[ºvar].show();
        }
    },
};


/* INDIVIDUAL COMPONENT: Facets
 * This sets up a list of facets for the lists of records to be displayed in the middle column
 * It will host individual facets
 */

function ºFacet(ºcomponent) {
    this.ºcomponent = ºcomponent;
    this.º_stats = {};
    this.ºdata = {};
    this.ºtable = {};
    this.ºdistilled = {};
    this.ºenabled_facets = {};
};

ºFacet.prototype = {
    º_html: function(ºvar) {
        var ºh = ``;
        ºh += `<p>Filtering <span id="fstats_${ºvar}"></span></p>`;
        this.ºcomponent.ºcontainer[ºvar].html(ºh);
    },
    º_display: function(ºvar, ºmode) {
    },
    ºshow: function(ºvar) {
        return this.ºcomponent.ºstate.ºgetState(`list`) == ºvar;
    },
    ºweld: function(ºvar) {
        var ºchildren = this.ºcomponent.ºchildren;
        this.ºenabled_facets[ºvar] = {};
        for (var ºfacet_name in ºchildren) {
            var ºfacet_component = ºchildren[ºfacet_name];
            if (ºfacet_component.ºhasVariant(ºvar)) {
                this.ºenabled_facets[ºvar][ºfacet_name] = ºchildren[ºfacet_name];
            }
        }
        this.º_html(ºvar);
    },
    ºwire: function(ºvar) {
        var ºcc = this.ºcomponent.ºcontainer[ºvar];
        var ºlc = this.ºcomponent.ºpage.ºgetComponent(`ºlist`).ºcontainer[ºvar];
        this.º_stats[ºvar] = ºcc.find(`#fstats_${ºvar}`);
        this.ºtable[ºvar] =  ºlc.find(`#table_${ºvar}`);
        var ºdetailcontrols = `<a class="showc fa fa-chevron-right" href="#" title="Show details"></a><a class="morec fa fa-chevron-down" href="#" title="Less details"></a><a class="hidec fa fa-chevron-up" href="#" title="Hide details"></a>`;
        ºcc.addClass(`•facet`);
        ºcc.find(`p.•dctrl`).each(function() {
            var ºorig = $(this).html();
            $(this).html(`${ºdetailcontrols}&nbsp;${ºorig}`);
        });
        ºcc.find(`p.•dctrl`).closest(`div`).find(`table,.•flt`).hide();
        ºcc.find(`p.•dctrl`).closest(`div`).find(`.•value_list2,.•flt_compact`).show();
        ºcc.find(`.hidec`).show();
        ºcc.find(`.morec`).hide();
        ºcc.find(`.showc`).hide();
        ºcc.find(`.hidec`).click(function(ºe) {ºe.preventDefault();
            var ºdt = $(this).closest(`p`);
            var ºkey = $(this).closest(`div.•component`).attr(`id`);
            $(this).closest(`div`).find(`table,.•flt`).hide();
            $(this).closest(`div`).find(`.•value_list2,.•flt_compact`).hide();
            ºdt.find(`.hidec`).hide();
            ºdt.find(`.morec`).hide();
            ºdt.find(`.showc`).show();
        });
        ºcc.find(`.morec`).click(function(ºe) {ºe.preventDefault();
            var ºdt = $(this).closest(`p`);
            var ºkey = $(this).closest(`div.•component`).attr(`id`);
            $(this).closest(`div`).find(`table,.•flt`).hide();
            $(this).closest(`div`).find(`.•value_list2,.•flt_compact`).show();
            ºdt.find(`.hidec`).show();
            ºdt.find(`.morec`).hide();
            ºdt.find(`.showc`).hide();
        });
        ºcc.find(`.showc`).click(function(ºe) {ºe.preventDefault();
            var ºdt = $(this).closest(`p`);
            var ºkey = $(this).closest(`div.•component`).attr(`id`);
            $(this).closest(`div`).find(`table,.•flt`).show();
            $(this).closest(`div`).find(`.•value_list2,.•flt_compact`).hide();
            ºdt.find(`.hidec`).hide();
            ºdt.find(`.morec`).show();
            ºdt.find(`.showc`).hide();
        });
    },
    ºwork: function(ºvar) {
        this.ºtable[ºvar].find(`tr[id]`).hide();
        var ºmother_list = this.ºcomponent.ºpage.ºgetComponent(`ºlist`);
        var ºdata = ºmother_list.ºdata[ºvar];
        var ºfacets = this.ºenabled_facets[ºvar];
        this.ºdistilled[ºvar] = [];
        for (var ºfacet_name in ºfacets) {
            var ºfacet= ºfacets[ºfacet_name].ºimplementation;
            ºfacet.ºdistilled[ºvar] = [];
        }
        ºdata.forEach(function(ºd, ºi) {
            var ºv = true; // will hold whether this row passes all facets
/* We collect in the ºdistilled member of this facet object the collective results of all individual facets,
 * Moreover, for each facet, we collect in its ºdistilled member the results when all facets are applied except the facet in question
 * so: 
 * 1. rows with a failure for 2 or more facets are discarded
 * 2. rows with a failure for exactly one facet are added to the data for that facet
 * 3. rows which pass all facets are added to all facets, and also to the final filtered set
 */
            var ºthe_false = null; // which facet has yielded false (if there are more than one we'll ºdiscard the row
            var ºdiscard = false; // becomes true when we have encounterd 2 facets that yield false
            for (var ºfacet_name in ºfacets) {
                if (!ºdiscard) {
                    var ºfacet = ºfacets[ºfacet_name].ºimplementation;
                    var ºthis_v = ºfacet.ºv(ºvar, ºd[0]); // ºthis_v: whether the row passes this facet
                    if (!ºthis_v) {
                        ºv = false;
                        if (ºthe_false == null) { // this is the first failure, we store the facet number in ºthe_false
                            ºthe_false = ºfacet;
                        } // else we ºdiscard the row altogether
                        else {
                            ºdiscard = true;
                        }
                    }
                }
            }
            if (!ºdiscard) {
                if (ºv) {
                    this.ºdistilled[ºvar].push(ºd[0]);
                    this.ºtable[ºvar].find(`tr[id="r${ºd[0]}"]`).show();
                }
                if (ºthe_false != null) {
                    ºthe_false.ºdistilled[ºvar].push(ºd[0]);
                }
                else {
                    for (var ºfacet_name in ºfacets) {
                        var ºfacet = ºfacets[ºfacet_name].ºimplementation;
                        ºfacet.ºdistilled[ºvar].push(ºd[0]);
                    }
                }
            }
        }, this);
        for (var ºfacet_name in ºfacets) {
            var ºfacet = ºfacets[ºfacet_name].ºimplementation;
            ºfacet.ºstats(ºvar);
        }
        this.º_stats[ºvar].html(`${this.ºdistilled[ºvar].length} of ${ºdata.length}`);
    },
};


/* INDIVIDUAL COMPONENT: ºList
 * This manages the actual lists of records to be displayed in the middle column.
 * The subcomponents corresponds to the individual lists, such as country, countribution
 * All functionality (except ºshow) is delegated to ºspecific functions
 */

function ºList(ºcomponent) {this.ºcomponent = ºcomponent};

ºList.prototype = {
    º_html: function(ºvar) {
        var ºh = ``;
        ºh += `<table id="table_${ºvar}">`;
        if (ºvar == `contrib`) {
            this.ºcomponent.ºdata[ºvar].forEach(function(ºr) {
                ºh += `<tr id="r${ºr[0]}"><td><a href="#" rid="${ºr[0]}">${ºr[1]}</a></td></tr>`;
            });
        }
        else if (ºvar == `country`) {
            this.ºcomponent.ºdata[ºvar].forEach(function(ºr) {
                ºin_dariah = (ºr[3] == 1)?`dariah`:``;
                ºh += `<tr id="r${ºr[0]}"><td class="•country_code">${ºr[1]}<td><td class="•country_name">${ºr[2]}<td><td class="•in_dariah">${ºin_dariah}</td><td class="•latlng">${ºr[4]}</td><td class="•latlng">${ºr[5]}</td></tr>`;
            });
        }
        else if (ºvar == `type` || ºvar == `tadiraha` || ºvar == `tadiraho` || ºvar == `tadiraht`) {
            this.ºcomponent.ºdata[ºvar].forEach(function(ºr) {
                ºh += `<tr id="r${ºr[0]}"><td class="•value">${ºr[1]}<td></tr>`;
            });
        }
        ºh += `</table>`;
        this.ºcomponent.ºcontainer[ºvar].html(ºh);
    },
    ºshow: function(ºvar) {
        return this.ºcomponent.ºstate.ºgetState(`list`) == ºvar;
    },
    ºweld: function(ºvar) {
        this.º_html(ºvar);
    },
    ºwire: function(ºvar) {
    },
    ºwork: function(ºvar) {},
};


/* INDIVIDUAL COMPONENT: ºControl
 * This manages the controls that correspond to lists of records to be displayed in the middle column
 * Clicking on a control shows the corresponding list and hides all others.
 */

function ºControl(ºcomponent) {
    this.ºcomponent = ºcomponent;
    this.ºwidget = {};
    this.ºctl = {};
};

ºControl.prototype = {
    º_html: function(ºvar) {
        this.ºcomponent.ºcontainer[ºvar].html(`<a class="•control_title" href="#">${this.ºcomponent.ºstate.ºshowState('list', ºvar, 'ºsg')}</a> `);
    },
    º_dressup: function(ºvar) {
        this.ºctl[ºvar].click(function(ºe) {ºe.preventDefault();
            this.ºcomponent.ºstate.ºsetState(`list`, ºvar);
        }.bind(this))
    },
    º_isActive: function(ºvar) {
        return this.ºcomponent.ºstate.ºgetState(`list`) == ºvar;
    },
    ºshow: function(ºvar) {
        return true;
    },
    ºweld: function(ºvar) {
        this.º_html(ºvar);
        this.ºwidget[ºvar] =  this.ºcomponent.ºcontainer[ºvar];
        this.ºwidget[ºvar].addClass(`•control_big`);
        this.ºctl[ºvar] =  this.ºcomponent.ºcontainer[ºvar].find(`a`);
    },
    ºwire: function(ºvar) {
        this.º_dressup(ºvar);
    },
    ºwork: function(ºvar) {
        if (this.º_isActive(ºvar)) {
            this.ºctl[ºvar].addClass(`•ison`);
            this.ºwidget[ºvar].addClass(`•ison`);
        }
        else {
            this.ºctl[ºvar].removeClass(`•ison`);
            this.ºwidget[ºvar].removeClass(`•ison`);
        }
    }
};

/* COMPONENTS 
 * The ºPage function specifies and builds a list of components
 * Every component on the page corresponds to a function (with a prototype)
 * This function is stored in a generic ºComponent function in a field called ºspecific.
 * Every component has a list of subcomponents. For example, the 'list' component has a subcomponent 'contrib'
 * for the list of contributions, and a subcomponent 'country' for the list of ºcountries.
 * The generic functions of a component take care of:
 * - generating HTML ºcontainer divs for the subcomponents under specified destination elements if they does not already exist
 * - showing and hiding the subcomponents, and in general, ºwork the current state data to the subcomponents 
 * - fetching the subcomponent's data from the server, if needed
 * This *ºspecific* functionality of the components are defined in separate files.
 * Of this ºspecific functionality, the following will be called from the generic component function:
 * - ºshow(ºvar): inspect the current state and determine whether the subcomponent should be shown or hidden
 * - ºwire(ºvar): after the data has been fetched, wrap the data into the desired HTML content of the subcomponent
 *   and add the wiring (click events, change events)
 * In turn, the ºspecific functions can access their associated generic components by this.ºcomponent
 */

/* GENERIC COMPONENT
 * Here is the generic functionality of each component
 */

function ºComponent(ºname, ºspecs, ºpage) {
    this.ºname = ºname;
    this.ºpage = ºpage;
    this.ºspecs = ºspecs;
    this.ºvariants = ºspecs.ºvariants;
    this.º_stage = {};
    for (var ºvar in this.ºvariants) {
        this.º_stage[ºvar] = {};
        for (var ºst in this.ºpage.ºstages) {
            this.º_stage[ºvar][ºst] = true;
        }
    }
    this.ºmsg = {};
    this.ºcontainer = {};
    this.ºstate = this.ºpage.ºstate;
    this.ºdata = {};
    this.ºrelated_values = {};
    this.ºimplementation = new ºspecs.ºspecific(this);
};

ºComponent.prototype = {
    /* ºneed, ºdeed, ºensure are wrappers around the promise mechanism.
     * The ºstage is a stage in processing the component, such as fetch, ºwire, ºwork.
     * There should be a method method which does the ºwork and which is expected to return a promise.
     * If it does not, we detect it, and yield a promise that is resolved with the original return value.
     * ºensure takes care that the function of an action is promised to be execute once, by registering it
     * as a promise for that stage.
     * If there is already a fulfilled or pending promise for that action at that stage, no new promise will be made.
     * Ensure returns a function with no arguments. If it is called, the promise will be made.
     * So the ºresult of ºensure can be put inside the .then() of an other promise.
     * Now is a function that calls a function and returns the ºresult as promise.
     */
    ºneed: function(ºvar, ºstage) { // check whether there is a promise and whether it has been fulfilled
        return !this.º_stage[ºvar][ºstage].state || (this.º_stage[ºvar][ºstage].state() == `rejected`);
    },
    º_deed: function(ºvar, ºstage, ºmethod) { // register a promise to perform the method associated with ºstage by entering it in the book keeping of stages
            /* we want to pass a method call to a .then() later on.
             * If we pass it straight, like this.method, .then() will call this function and supplies its own promise object as the this.
             * That is not our purpose: we want to call the method with the current component object as the this.
             * Hence we use bind() in order to supply the right this.
             * Whoever calls this new function ºmethodCall, will perform a true method call of method ºmethod on object that.
             * This is crucial, otherwise all the careful time logic gets mangled, because the promises are stored in the component object.
             */
        var ºmethodCall = this[ºmethod].bind(this, ºvar);
        var ºtiming = this.ºpage.ºgetBefore(this.ºname, ºstage);
        var ºpromises = [];
        ºtiming.forEach(function(ºtask) {
            var ºprev_name = ºtask[0];
            var ºprev_stage = ºtask[1];
            var ºprev_component = this.ºpage.ºgetComponent(ºprev_name);
            if (ºprev_component.ºhasVariant(ºvar)) {
                ºpromises.push(ºprev_component.º_stage[ºvar][ºprev_stage]);
            }
        }, this);
        this.º_stage[ºvar][ºstage] = $.when.apply($, ºpromises).then(ºmethodCall);
    },
    ºensure: function(ºvar, ºstage, ºmethod) {
        /* function to promise that method ºfun will be executed once and once only or multiple times,
         * but only if the before actions have been completed
         */
        if (ºstage in this.ºpage.ºstages) {
            if (!this.ºpage.ºstages[ºstage] || this.ºneed(ºvar, ºstage)) {
                this.º_deed(ºvar, ºstage, ºmethod);
            }
        }
    },
    /* here are the implementations of the functions that are to be wrapped as promises
     * They can focus on the ºwork, may or may not yield a promise
     */    
    ºhasVariant: function(ºvar) {
        return (ºvar in this.ºvariants);
    },
    º_visibility: function(ºvar, ºon) {
        if (this.ºhasVariant(ºvar)) {
            if (ºvar in this.ºcontainer) {
                if (ºon) {
                    this.ºcontainer[ºvar].show();
                }
                else {
                    this.ºcontainer[ºvar].hide();
                }
            }
        }
    },
    º_fetch: function(ºvar) { // get the material by AJAX if needed
        var ºfetch_url = url_tpl.replace(/_c_/, `data`).replace(/_f_/, `${this.ºspecs.ºfetch_url}_${ºvar}`)+`.json`;
        this.ºmsg[ºvar].ºmsg(`fetching data ...`);
        var ºpostFetch = this.º_postFetch.bind(this, ºvar);
        return $.ajax({
            type: `POST`,
            url: ºfetch_url,
            contentType: `application/json; charset=utf-8`,
            dataType: `json`,
        }).then(function(ºjson) {
            ºpostFetch(ºjson);
        });
    },
    º_postFetch: function(ºvar, ºjson) { // receive material after AJAX call
        this.ºmsg[ºvar].ºclear();
        ºjson.msgs.forEach(function(ºm) {
            this.ºmsg[ºvar].ºmsg(ºm);
        }, this);
        if (ºjson.good) {
            this.ºdata[ºvar] = ºjson.data;
            if (`relvals` in ºjson) {
                this.ºrelated_values[ºvar] = ºjson.relvals;
            }
        }
        this.ºimplementation.ºweld(ºvar);
        console.log(`_WELD END ${this.ºname}-${ºvar}`);
    },
    º_weld: function(ºvar) {
        console.log(`_WELD BEGIN ${this.ºname}-${ºvar}`);
        this.º_dst = this.ºpage.ºgetContainer(this.ºspecs.ºdest, this.ºvariants);
        this.ºcontainer[ºvar] = $(`#${this.ºname}_${ºvar}`);
        if (this.ºcontainer[ºvar].length == 0) {
            var ºdestination = this.º_dst[ºvar];
            ºdestination.append(`<div id="msg_${this.ºname}_${ºvar}"></div>`);
            ºdestination.append(`<div id="${this.ºname}_${ºvar}" class="•component"></div>`);
            this.ºcontainer[ºvar] = $(`#${this.ºname}_${ºvar}`);
        }
        this.ºmsg[ºvar] = new ºMsg(`msg_${this.ºname}_${ºvar}`);
        if (this.ºspecs.ºfetch_url != null) {
            return this.º_fetch(ºvar);
        }
        else {
            this.ºimplementation.ºweld(ºvar);
            console.log(`_WELD END ${this.ºname}-${ºvar}`);
        }
    },
    º_wire: function(ºvar) {
        console.log(`_WIRE ${this.ºname}-${ºvar}`);
        this.ºimplementation.ºwire(ºvar); // perform ºwire actions that are ºspecific to this component
    },
    º_work: function(ºvar) {
        console.log(`_WORK ${this.ºname}-${ºvar}`);
        this.º_visibility(ºvar, true);
        this.ºimplementation.ºwork(ºvar); // perform ºwork actions that are ºspecific to this component
    },
    ºwork: function(ºvar) { // ºwork (changed) state to current material
        if (this.ºhasVariant(ºvar) && this.ºimplementation.ºshow(ºvar)) { // ºshow/hide depending on the ºspecific condition
            this.ºensure(ºvar, `ºweld`, `º_weld`);
            this.ºensure(ºvar, `ºwire`, `º_wire`);
            this.ºensure(ºvar, `ºwork`, `º_work`);
        }
        else {
            this.º_visibility(ºvar, false);
        }
    },
    ºweld: function(ºvar) {
        if (this.ºhasVariant(ºvar) && this.ºimplementation.ºshow(ºvar)) {
            this.ºensure(ºvar, `ºweld`, `º_weld`);
        }
    },
    ºwire: function(ºvar) {
        if (this.ºhasVariant(ºvar) && this.ºimplementation.ºshow(ºvar)) {
            this.ºensure(ºvar, `ºwire`, `º_wire`);
        }
    },
    ºwork: function(ºvar) { // ºwork (changed) state to current material
        if (this.ºhasVariant(ºvar) && this.ºimplementation.ºshow(ºvar)) { // ºshow/hide depending on the ºspecific condition
            this.ºensure(ºvar, `ºwork`, `º_work`);
        }
        else {
            this.º_visibility(ºvar, false);
        }
    },
};

/* TOP LEVEL: PAGE
 * This is the page function. 
 * It creates a ViewState function, which contains the current state.
 * The state is created on the basis of request variables, and from then it
 * reflects the user actions.
 * The page specifies all components and initializes them.
 * A component is specfied by the following fields
 * - destination: left => left sidebar; right => right sidebar; middle => middle column
 * - ºname: a string that can be used to refer to the component later on, via method ºgetComponent
 * - subcomponents: a list of names for which a subcomponent will be made. The html will be generated per subcomponent.
 * - fetch: boolean which says whether this component needs data from the server
 * - ºwork first: boolean which says that child components can only be wired after ºwork of the ºparent component.
 * - ºspecific: an object that holds the ºspecific functionality of this component.
 * The control component has ºwork first = true, because only after choosing a list, the list control can fetch the ºspecific list and ºwire itself.
 * All other components have ºwork first = false, because it is desirable that child components start wiring as soon as possible.
 * For example: the facet component is ºparent of the individual facets.
 * When facet starts working, the individual controls should already be wired.
 * Because ºwork first = false, wiring of the individual facets will be triggered after wiring of the generic facet component.
 * N.B. Individual facets can only be wired after the list component (their grandfather) has been wired.
 * This will go OK, because after wiring the list, the facet will be wired and then the individual facets.
 * The º_routing dictionary specifies when the ºwork methods of components should be triggered.
 * Its keys are the labels of components, and for every component a list of other component keys is given.
 * These are the components that will be applied (in that order) after the key component. 
 * 
 *  ºwork from page: if true, this component's ºwork method will be called directly by the page's ºwork method;
 *   if false, the page will skip this component when working. It is assumed that this component will be applied by another component.
 *   This practice must be followed, if the application of state to a component should come after a fetch of another component.
 *   If the page would ºwork the viewstate directly to this component, it would happen before the other's components data had been loaded.
 *   Example: a filter component F, that filters a big list fetched by another component L. L's ºwork should call F's ºwork.
 * After every user action, the state is changed, and a call to the ºPage's ºwork() method is issued.
 * The page will issue the ºwork call forth to all components.
 */

function ºPage() { // the one and only page object
    this.ºname = `page`;
    this.ºmsg = new ºMsg(`msg_${this.ºname}`);
    this.ºstate = new ºViewState(this);
    this.ºstages = {ºweld: true, ºwire: true, ºwork: false}; // true means: once only, false means: my be repeated
    this.ºstages_prev = {ºwire: `ºweld`, ºwork: `ºwire`};
    var ºmain_lists = this.ºstate.ºgetValues(`list`);
    var ºcontrib_list = {contrib: 1};
    this.º_component_specs = {
        ºcontrol: {ºdest: `left`, ºvariants: ºmain_lists, ºfetch_url: null, ºspecific: ºControl}, 
        ºlist: {ºdest: `middle`, ºvariants: ºmain_lists, ºfetch_url: `list`, ºspecific: ºList}, 
        ºfacet: {ºdest: `ºcontrol`, ºvariants: ºmain_lists, ºfetch_url: null, ºspecific: ºFacet}, 
        ºfilter: {ºdest: `ºfacet`, ºvariants: ºmain_lists, ºfetch_url: null, ºspecific: ºFilter}, 
        ºeumap: {ºdest: `ºfacet`, ºvariants: ºcontrib_list, ºfetch_url: `country`, ºspecific: ºEUmap}, 
        ºctype: {ºdest: `ºfacet`, ºvariants: ºcontrib_list, ºfetch_url: `type`, ºspecific: ºCType}, 
        ºtadiraha: {ºdest: `ºfacet`, ºvariants: ºcontrib_list, ºfetch_url: `tadiraha`, ºspecific: ºTadirahA}, 
        ºtadiraho: {ºdest: `ºfacet`, ºvariants: ºcontrib_list, ºfetch_url: `tadiraho`, ºspecific: ºTadirahO}, 
        ºtadiraht: {ºdest: `ºfacet`, ºvariants: ºcontrib_list, ºfetch_url: `tadiraht`, ºspecific: ºTadirahT}, 
    },
    this.º_before = {
        ºweld: {
            ºfacet: {ºcontrol: 1, ºlist: 1},
            ºfilter: {ºfacet: 1},
            ºeumap: {ºfacet: 1, ºfilter: 1},
            ºctype: {ºfacet: 1, ºeumap: 1},
            ºtadiraha: {ºfacet: 1, ºctype: 1},
            ºtadiraho: {ºfacet: 1, ºtadiraha: 1},
            ºtadiraht: {ºfacet: 1, ºtadiraho: 1},
        },
        ºwire: {
            ºfacet: {ºfilter: 1, ºeumap: 1, ºctype: 1, ºtadiraha: 1, ºtadiraho: 1, ºtadiraht: 1},
            ºfilter: {ºlist: 1},
            ºeumap: {ºlist: 1},
            ºctype: {ºlist: 1},
            ºtadiraha: {ºlist: 1},
            ºtadiraho: {ºlist: 1},
            ºtadiraht: {ºlist: 1},
        },
        ºwork: {
            ºfacet: {ºfilter: 1, ºeumap: 1, ºctype: 1, ºtadiraha: 1, ºtadiraho: 1, ºtadiraht: 1},
        },
    };
    this.ºcomponents = {};
    for (var ºname in this.º_component_specs) {
        var ºcomponent = new ºComponent(ºname, this.º_component_specs[ºname], this);
        ºcomponent.ºchildren = {};
        this.ºcomponents[ºname] = ºcomponent;
    }
    for (var ºname in this.º_component_specs) {
        var ºchild_component = this.ºcomponents[ºname];
        var ºdest_name = this.º_component_specs[ºname].ºdest;
        if (ºdest_name in this.ºcomponents) {
            var ºparent_component = this.ºcomponents[ºdest_name];
            ºparent_component.ºchildren[ºname] = ºchild_component;
        }
    }
    for (var ºname in this.ºcomponents) {
        var ºcomponent = this.ºcomponents[ºname];
        ºcomponent.ºbefore = {};
        for (var ºstage in this.º_before) {
            var ºconstraints = this.º_before[ºstage];
            ºcomponent.ºbefore[ºstage] = {};
            if (ºname in ºconstraints) {
                for (var ºbefore_name in ºconstraints[ºname]) {
                   ºcomponent.ºbefore[ºstage][ºbefore_name] = 1;
                } 
            }
        }
    }
    this.º_resolveTiming();
    this.º_setHeight(80);
    History.Adapter.bind(window, `statechange`, this.ºstate.ºwork());
};

ºPage.prototype = {
    º_setHeight(ºsubtract) { // the heights of the sidebars are set, depending on the height of the window
        var ºwh = `${window.innerHeight - ºsubtract}px`;
        for (var ºw in {'middle': 1, 'left': 1, 'right': 1}) {
            $(`#${ºw}`).css(`height`, ºwh);
        }
    },
    º_resolveTiming() {
        /* the time constraints must form a directed acyclic graph.
         * If that is the case, we need a linear order in which we can make the promises
         * This function will calculate that order (of course, several orders are possible)
         * Algorithm:
         *
         * A: make a graph of all tasks, a task is the combination of a component with a stage.
         *
         * B: compute sets of nodes that have a longest predecessor path of fixed length n
         *
         * 1. determine all tasks without predecessors, this is S0                                                (max length of predecessor chain = 0)
         * 2. determine all tasks with all predecessors in S0, this is S1                                             (max length of predecessor chain = 1)
         * 3. determine all tasks with: all predecessors in S0 or S1, at least one predecessor in S1, this is S2  (max length of predecessor chain = 2)
         * ...
         * n+1. determine all tasks with: all predecessors in S0, S1, ..., Sn, at least ione predecessor in Sn
         *
         * C: 
         * Prove theorem 1: Sn = {all nodes with longest chain of predecessors has length n}.
         * Prove theorem 2: all nodes outside union of all Sn: they are part of a cycle.
         *
         * D: 
         * The required order is: first the nodes of S0 (in any order), then those of S1, then those of S2, and so on.
         */
        var ºtiming_nodes = [];
        var ºtiming_edges = {}; // keys are nodes that must come before other nodes
        var ºtiming_edges_inv = {}; // keys are nodes that must come after other nodes
        // A: collect the nodes: pairs of component name and stage
        for (var ºname in this.º_component_specs) {
            for (var ºstage in this.ºstages) {
                ºtiming_nodes.push(`${ºname}-${ºstage}`);
            }
        }
        // collect the edges (we need to store every edge both ways)
        function ºaddEdge(ºprev_node, ºnext_node) {
            if (!(ºprev_node in ºtiming_edges)) {
                ºtiming_edges[ºprev_node] = {};
            }
            if (!(ºnext_node in ºtiming_edges_inv)) {
                ºtiming_edges_inv[ºnext_node] = {};
            }
            ºtiming_edges[ºprev_node][ºnext_node] = true;
            ºtiming_edges_inv[ºnext_node][ºprev_node] = true;
        }
        // 1. per component, the stages are ordered
        for (var ºnext_stage in this.ºstages_prev) {
            var ºprev_stage = this.ºstages_prev[ºnext_stage];
            for (var ºname in this.º_component_specs) {
                ºaddEdge(`${ºname}-${ºprev_stage}`, `${ºname}-${ºnext_stage}`);
            }
        }
        // 2. add the specific constraints from this.º_before
        for (var ºstage in this.º_before) {
            for (var ºnext_name in this.º_before[ºstage]) {
                for (var ºprev_name in this.º_before[ºstage][ºnext_name]) {
                    ºaddEdge(`${ºprev_name}-${ºstage}`, `${ºnext_name}-${ºstage}`);
                }
            }
        }
        // B: compute the Sn (in ºsubset)
        var ºn = 0;
        var ºsubset = [];
        var ºvisited = {}; // collect all nodes that end up in an Sn
        while (ºn <= ºtiming_nodes.length) {
            ºsubset.push({});
            if (ºn == 0) {                                                // first round
                ºtiming_nodes.forEach(function(ºnode) {                   // select all nodes without prev_nodes
                    if (!(ºnode in ºtiming_edges_inv)) {
                        ºsubset[ºn][ºnode] = 1;                          // and store them in subset[0]              
                    }
                });
            }
            else {
                for (var ºprev_node in ºvisited) {                          // start with prev_nodes in visited
                    if (ºprev_node in ºtiming_edges) {                      // and consider their next_nodes
                        for (var ºnext_node in ºtiming_edges[ºprev_node]) {
                            if (!(ºnext_node in ºvisited)) {                // but only if the next_node is not yet visited
                                var ºgood = true;
                                for (var ºother_prev_node in ºtiming_edges_inv[ºnext_node]) { // consider the other prev nodes of the next nodes
                                    if (!(ºother_prev_node in ºvisited)) { // and require that they have been visited already
                                        ºgood = false;
                                        break;
                                    }
                                } 
                                if (ºgood) {
                                    ºsubset[ºn][ºnext_node] = 1;           // if all is well, we add next_node to subset[ºn]
                                }
                            }
                        }
                    }
                }
            }
            if (!Object.keys(ºsubset[ºn]).length) {                                    // if there are no new nodes, the next rounds will also not yield new nodes,
                break;                                                    //  so we are done
            }
            for (var ºnode in ºsubset[ºn]) {                              // after each round we add the saved next_nodes to the visited nodes
                ºvisited[ºnode] = 1;
            }
            ºn++;
        }
        this.º_tasks = [];
        this.º_timing = {};
        if (Object.keys(ºvisited).length != ºtiming_nodes.length) {
            var ºcycle = [];
            ºtiming_nodes.forEach(function(ºnode) {
                if (!(ºnode in ºvisited)) {
                    ºcycle.push(ºnode);
                }
            });
            console.log(`Circular timing constraints detected`, ºcycle);
        }
        else {
            ºsubset.forEach(function(ºnodes, ºn) {
                for (var ºnode in ºnodes) {
                    this.º_tasks.push(ºnode);
                }
            }, this);
            this.º_timing = ºtiming_edges_inv;
            console.log(`Timing resolved`, this.º_tasks);
        }
    },
    ºgetComponent: function(ºname) {
        return this.ºcomponents[ºname];
    },
    ºgetContainer: function(ºname, ºvariants) {
        var ºcontainer = {};
        if (ºname in this.ºcomponents) {
            ºcontainer = this.ºcomponents[ºname].ºcontainer;
        }
        else {
            for (var ºvar in ºvariants) {
                ºcontainer[ºvar] = $(`#${ºname}`);
            }
        }
        return ºcontainer;
    },
    ºgetBefore: function(ºname, ºstage) {
        var ºprev_nodes = [];
        var ºnext_node = `${ºname}-${ºstage}`;
        for (var ºprev_node in (this.º_timing[ºnext_node] || {})) {
            ºprev_nodes.push(ºprev_node.split(`-`));
        }
        return ºprev_nodes;
    },
    ºwork: function() { 
        this.º_tasks.forEach(function(ºtask) {
            var ºtask_comps = ºtask.split(`-`);
            var ºname = ºtask_comps[0];
            var ºstage = ºtask_comps[1];
            var ºcomponent = this.ºgetComponent(ºname);
            for (var ºvar in ºcomponent.ºvariants) {
                ºcomponent[ºstage](ºvar);
            }
        }, this);
    },
};


/* START PROCESSING
 * The dynamic construction of the page starts here
 */


$(function() {new ºPage().ºwork()});
