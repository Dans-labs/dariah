function Component(dst,name,scomps,fetch,specific,page){this.dst=dst;this.name=name;this.scomps=scomps;this.fetch=fetch;this.page=page;this.specific=specific;};Component.prototype={_fetch:function(sc){var that=this;if(this.fetch){this.msg[sc].msg(`fetching data ...`);$.post(this._fetch_url[sc],{},function(json){that.msg[sc].clear();json.msgs.forEach(function(m){that.msg[sc].msg(m);});if(json.good){that.data[sc]=json.data;that.process(sc);}},`json`);}else{this.process(sc);}},_apply:function(sc){this.delg.apply(sc);this.page.apply(this.name,sc);},init:function(){this._dst={};this._loaded={};this.msg={};this.container={};this.state=this.page.state;this.data={};this._fetch_url={};for(var sc in this.scomps){this._loaded[sc]=false;if(this.fetch){this._fetch_url[sc]=url_tpl.replace(/_c_/,`data`).replace(/_f_/,`${this.name}_${sc}`)+`.json`;}}this.delg=new this.specific(this);if(this.dst in this.page.compindex){var dstcontainer=this.page.compindex[this.dst].container;for(var sc in this.scomps){this._dst[sc]=dstcontainer[sc];}}else{var dst=$(`#${this.dst}`);for(var sc in this.scomps){this._dst[sc]=dst;}}for(var sc in this.scomps){this.container[sc]=$(`#${this.name}_${sc}`);if(this.container[sc].length==0){var dst=this._dst[sc];dst.append(`<div id="msg_${this.name}_${sc}"></div>`);dst.append(`<div id="${this.name}_${sc}"></div>`);this.container[sc]=$(`#${this.name}_${sc}`);}this.msg[sc]=new Msg(`msg_${this.name}_${sc}`);this._loaded[sc]=false;this.delg.init(sc);}},process:function(sc){this._loaded[sc]=true;this.delg.process(sc);this._apply(sc)},apply:function(sc){var scomps={};if(sc==undefined){scomps=this.scomps;}else{scomps[sc]=1;}for(var s in scomps){if(this.delg.show(s)){this.container[s].show();if(!this._loaded[s]){this._fetch(s);}else{this._apply(s);}}else{this.container[s].hide();this._apply(s);}}},};function Control(comp){this.comp=comp;this.widget={};this.ctl={};};Control.prototype={_html:function(sc){this.comp.container[sc].html(`<a class="ctrl radio" href="#">${this.comp.state.showstate('list', sc, 'sg')}</a> `);},_dressup:function(sc){var that=this;this.ctl[sc].click(function(e){e.preventDefault();that.comp.state.setstate(`list`,sc);})},_is_active:function(sc){return this.comp.state.getstate(`list`)==sc;},show:function(sc){return true;},init:function(sc){this._html(sc);this.widget[sc]=this.comp.container[sc];this.ctl[sc]=this.comp.container[sc].find(`a`);this._dressup(sc);},process:function(sc){},apply:function(sc){if(this._is_active(sc)){this.ctl[sc].addClass(`ison`);this.widget[sc].addClass(`isonn`);}else{this.ctl[sc].removeClass(`ison`);this.widget[sc].removeClass(`isonn`);}}};function EUmap(comp){this.comp=comp;this.enabled={contrib:1};};EUmap.prototype={_html:function(sc){this.comp.container[sc].html(`
<p class="devel">by country:(under construction, not yet working!)</p>
<div id="map-europe">
 <ul class="europe">
  <li class="eu1"><a href="#albania">Albania</a></li>
  <li class="eu2"><a href="#andorra">Andorra</a></li>
  <li class="eu3"><a href="#austria">Austria</a></li>
  <li class="eu4"><a href="#belarus">Belarus</a></li>
  <li class="eu5"><a href="#belgium">Belgium</a></li>
  <li class="eu6"><a href="#bosnia-and-herzegovina">Bosnia and Herzegovina</a></li>
  <li class="eu7"><a href="#bulgaria">Bulgaria</a></li>
  <li class="eu8"><a href="#croatia">Croatia</a></li>
  <li class="eu9"><a href="#cyprus">Cyprus</a></li>
  <li class="eu10"><a href="#czech-republic">Czech Republic</a></li>
  <li class="eu11"><a href="#denmark">Denmark</a></li>
  <li class="eu12"><a href="#estonia">Estonia</a></li>
  <li class="eu13"><a href="#france">France</a></li>
  <li class="eu14"><a href="#finland">Finland</a></li>
  <li class="eu15"><a href="#georgia">Georgia</a></li>
  <li class="eu16"><a href="#germany">Germany</a></li>
  <li class="eu17"><a href="#greece">Greece</a></li>
  <li class="eu18"><a href="#hungary">Hungary</a></li>
  <li class="eu19"><a href="#iceland">Iceland</a></li>
  <li class="eu20"><a href="#ireland">Ireland</a></li>
  <li class="eu21"><a href="#san-marino">San Marino</a></li>
  <li class="eu22"><a href="#italy">Italy</a></li>
  <li class="eu23"><a href="#kosovo">Kosovo</a></li>
  <li class="eu24"><a href="#latvia">Latvia</a></li>
  <li class="eu25"><a href="#liechtenstein">Liechtenstein</a></li>
  <li class="eu26"><a href="#lithuania">Lithuania</a></li>
  <li class="eu27"><a href="#luxembourg">Luxembourg</a></li>
  <li class="eu28"><a href="#macedonia">Macedonia <abbr title="The Former Yugoslav Republic of Macedonia">(F.Y.R.O.M.)</abbr></a></li>
  <li class="eu29"><a href="#malta">Malta</a></li>
  <li class="eu30"><a href="#moldova">Moldova</a></li>
  <li class="eu31"><a href="#monaco">Monaco</a></li>
  <li class="eu32"><a href="#montenegro">Montenegro</a></li>
  <li class="eu33"><a href="#netherlands">Netherlands</a></li>
  <li class="eu34"><a href="#norway">Norway</a></li>
  <li class="eu35"><a href="#poland">Poland</a></li>
  <li class="eu36"><a href="#portugal">Portugal</a></li>
  <li class="eu37"><a href="#romania">Romania</a></li>
  <li class="eu38"><a href="#russian-federation">Russian Federation</a></li>
  <li class="eu39"><a href="#serbia">Serbia</a></li>
  <li class="eu40"><a href="#slovakia">Slovakia</a></li>
  <li class="eu41"><a href="#slovenia">Slovenia</a></li>
  <li class="eu42"><a href="#spain">Spain</a></li>
  <li class="eu43"><a href="#sweden">Sweden</a></li>
  <li class="eu44"><a href="#switzerland">Switzerland</a></li>
  <li class="eu45"><a href="#turkey">Turkey</a></li>
  <li class="eu46"><a href="#ukraine">Ukraine</a></li>
  <li class="eu47"><a href="#united-kingdom">United Kingdom</a></li>
<!-- 
  <li class="eu48"><a href="#england">England</a></li>
  <li class="eu49"><a href="#isle-of-man">Isle of Man</a></li>
  <li class="eu50"><a href="#northern-ireland">Northern Ireland</a></li>
  <li class="eu51"><a href="#scotland">Scotland</a></li>
  <li class="eu52"><a href="#wales">Wales</a></li>
-->
 </ul>
</div>
<p class="devel">selected: <input id="eu_sel"/></p>
        `);},_dressup:function(sc){$(`#map-europe`).CSSMap({mapStyle:`default`,size:320,cities:true,tooltips:`floating-top-center`,responsive:`auto`,fitHeight:false,mobileSupport:true,activateOnLoad:['eu33','eu20','eu17'],visibleList:{enable:true,columns:2,hideItems:['eu4','eu15','eu38','eu45','eu46'],},multipleClick:{enable:true,},formSupport:{enable:true,inputId:`#eu_sel`,value:`name`,},});},show:function(sc){return this.comp.state.getstate('list')==sc && sc in this.enabled;},init:function(sc){if(sc in this.enabled){this._html(sc);this._dressup(sc);}},process:function(sc){},apply:function(sc){if(this.show(sc)){this.comp.container[sc].show();}else{this.comp.container[sc].hide();}}};function Filter(comp){this.comp=comp;this._loaded={};this.tags={};this.fltc={};this.boxf={};this.autoc={};this.statsf={};this.clearf={};this.table={};};Filter.prototype={_html:function(sc){var h=``;h +=`<div class="flt" id="fltw_${sc}">`;h +=`<p id="fbox_${sc}" class="fbox ui-widget">`;h +=`filter <input id="flt_${sc}" class="flt"/>`;h +=`<span class="ctrl fa fa-close filtc" id="clearf_${sc}"></span>`;h +=`<span class="stats" id="stats_${sc}"></span>&nbsp;`;h +=`</p>`;h +=`<div id="autoc_${sc}" style="display: none;">here ${sc}</div>`;h +=`</div>`;this.comp.container[sc].html(h);},_set_flt:function(sc,textf){this.comp.container[sc].addClass(`flt`);this.fltc[sc].val(textf);this.fltc[sc].autocomplete(`search`,textf);if(this.comp.state.getstate(`f_${sc}`)!=textf){this.comp.state.setstate(`f_${sc}`,textf);}},_adapt_flt:function(sc,ui){var tln=this.tags[sc].length;var textf=this.fltc[sc].val();if(textf==''){this.boxf[sc].removeClass('ison');this.clearf[sc].hide();this.statsf[sc].html(`${tln}`);}else{var ln=ui.content.length;this.boxf[sc].addClass('ison');this.clearf[sc].show();this.statsf[sc].html(`${ln} of ${tln}`);}},_response:function(sc){var that=this;var tln=that.tags[sc].length;return function(event,ui){that.table[sc].find(`tr[id]`).hide();for(var i in ui.content){that.table[sc].find(`tr[id="r${ui.content[i].value}"]`).show();}that._adapt_flt(sc,ui);};},_setclear:function(sc){var that=this;this.clearf[sc].click(function(e){e.preventDefault();that._set_flt(sc,``);});},show:function(sc){return this.comp.state.getstate('list')==sc;},init:function(sc){this._html(sc);this._loaded[sc]=false;this.comp.container[sc]=$(`#fltw_${sc}`);this.fltc[sc]=$(`#flt_${sc}`);this.boxf[sc]=$(`#fbox_${sc}`);this.autoc[sc]=$(`#autoc_${sc}`);this.statsf[sc]=$(`#stats_${sc}`);this.clearf[sc]=$(`#clearf_${sc}`);},process:function(sc){},apply:function(sc){var that=this;this.table[sc]=$(`#table_${sc}`);if(this.show(sc)){if(!this._loaded[sc]){var data=this.comp.page.getcomp('list').data[sc];this.tags[sc]=[];for(var i in data){var term=data[i][1];if(term !=null && term !=''){var line=data[i];this.tags[sc].push({label:line[1],value:line[0]});}}this._setclear(sc);this.fltc[sc].autocomplete({appendTo:this.autoc[sc],source:this.tags[sc],response:this._response(sc),minLength:0,});this._set_flt(sc,this.comp.state.getstate(`f_${sc}`));this.fltc[sc].change(function(){that.comp.state.setstate(`f_${sc}`,$(this).val());});this._loaded[sc]=true;}this.comp.container[sc].show();}else{this.comp.container[sc].hide();}},};var escapeHTML=(function(){`use strict`;var chr={'&':`&amp;`,'<':`&lt;`,'>':`&gt;`};return function(text){return text.replace(/[&<>]/g,function(a){return chr[a];});};}());var Request={parameter:function(name){return this.parameters()[name];},parameters:function(uri){var i,parameter,params,query,result;result={};if(!uri){uri=window.location.search;}if(uri.indexOf("?")===-1){return{};}query=uri.slice(1);params=query.split("&");i=0;while(i < params.length){parameter=params[i].split("=");result[parameter[0]]=parameter[1];i++;}return result;}};var rvars=Request.parameters();var nslvars=$.initNamespaceStorage(`req`);var lvars=nslvars.localStorage;function List(comp){this.comp=comp};List.prototype={_html:function(sc){var h=``;h +=`<table id="table_${sc}">`;if(sc=='contrib'){for(var i in this.comp.data[sc]){r=this.comp.data[sc][i];h +=`<tr id="r${r[0]}"><td class="cc">${r[2]}<td><td class="cn">${r[3]}<td><td><a href="#" rid="${r[0]}">${r[1]}</a></td></tr>`;}}else if(sc=='country'){for(var i in this.comp.data[sc]){r=this.comp.data[sc][i];h +=`<tr id="r${r[0]}"><td class="cc">${r[0]}<td><td class="cn">${r[1]}<td></tr>`;}}h +=`</table>`;this.comp.container[sc].html(h);},show:function(sc){return this.comp.state.getstate('list')==sc;},init:function(sc){},process:function(sc){this._html(sc);},apply:function(sc){},};$(function(){(new Page()).apply(`page`)});function Msg(dst,on_clear){var that=this;this._dst=$(`#${dst}`);this._trashc=$(`#trash_${dst}`);this._trashp=this._trashc.closest(`p`);this._trashc.click(function(e){e.preventDefault();that.clear();});this._hide();this._on_clear=on_clear;};Msg.prototype={_hide:function(){this._dst.hide();this._trashp.hide();},_show:function(){this._dst.show();if(this._dst.html()!=``){this._trashp.show();}},clear:function(){this._dst.html(``);if(this._on_clear !=undefined){this._on_clear();}this._hide();},msg:function(text,kind){if(kind==undefined){kind=`info`;}var mtext=this._dst.html();this._dst.html(`${mtext}<p class="${kind}">${text}</p>`);this._show();},};function Page(){this.name='page';this.msg=new Msg(`msg_${this.name}`);this.state=new ViewState(this);var main_lists=this.state.getvalues('list');this._components=[['left','control',main_lists,false,Control],['control','filter',main_lists,false,Filter],['filter','eumap',main_lists,false,EUmap],['middle','list',main_lists,true,List],];this.compindex={};this._routing={page:['control'],control:['list'],list:['filter'],filter:['eumap'],};this.init();};Page.prototype={_set_height(subtract){var wh=`${window.innerHeight - subtract}px`;for(var w in{middle:1,left:1,right:1}){$(`#${w}`).css(`height`,wh);}},getcomp:function(name){return this.compindex[name];},init:function(){this.compindex={};for(var i in this._components){var c=this._components[i];var co=new Component(c[0],c[1],c[2],c[3],c[4],this);this.compindex[c[1]]=co;co.init();}this._set_height(80);History.Adapter.bind(window,`statechange`,this.state.apply());},apply:function(comp,sc){if(this._routing[comp]!=undefined){for(var i in this._routing[comp]){var oname=this._routing[comp][i];this.compindex[oname].apply(sc);}}},};function ViewState(page){this._data={};this.init();this.page=page;this.msg=page.msg;};ViewState.prototype={_specs:{list:{type:`string`,values:{contrib:1,country:1},def:`contrib`},f_contrib:{type:`string`,values:null,def:``},f_country:{type:`string`,values:null,def:``},id:{type:`integer`,values:{min:-1,max:1000000},def:0},sort:{type:`boolean`,values:{v:true,x:false},def:true},},_showas:{list:{contrib:{sg:'contribution',pl:'contributions'},country:{sg:'country',pl:'countries'},},},_validate:function(name,val){var newval,message;if(name in this._specs){var s=this._specs[name];if(s.type==`string`){if(s.values){if(val in s.values){newval=val;}else{newval=s.def;this.msg.msg(`illegal string value for ${name}: "${val}" is replaced by "${s.def}"`,`warning`);}}else{newval=val;}}else if(s.type==`integer`){if(/^(\-|\+)?[0-9]+$/.test(val)){newval=Number(val);}else{newval=s.def;this.msg.msg(`not a number value for ${name}: "${val}" is replaced by "${s.def}"`,`warning`);}}else if(s.type==`boolean`){if(val in s.values){newval=s.values[val];}else{newval=s.def;this.msg.msg(`illegal boolean value for ${name}: "${val}" is replaced by "${s.def}"`,`warning`);}}}else{newval=null;this.msg.msg(`unknown parameter: ${name}=${val}`,`warning`);}return newval;},_getvars:function(){vars=[];for(var name in this._data){var val=this._data[name];var spec=this._specs[name];if(spec.type==`string` || spec.type==`integer`){vars.push(`${name}=${val}`)}else if(spec.type==`boolean`){for(z in spec.values){if(spec.values[z]==val){vars.push(`${name}=${z}`)}}}}return vars.join('&')},_getinitstate:function(){for(var name in rvars){if(!(name in this._specs)){this.msg.msg(`unknown parameter: ${name}=${val}`,`warning`);}}for(var name in this._specs){var val=null;if(name in rvars){var raw_val=rvars[name];val=this._validate(name,raw_val);lvars.set(name,val);}else if(lvars.isSet(name)){val=lvars.get(name);}else{val=this._specs[name].def;lvars.set(name,val);}this._data[name]=val;}},_addHist:function(title,view_url){var tit=`DARIAH contribution tool`;var this_url=`${app_url}?${this._getvars()}`;History.pushState(this._data,tit,this_url);},setstate:function(name,val){this._data[name]=val;lvars.set(name,val);this._addHist();},getstate:function(name){return this._data[name];},getvalues:function(name){return this._specs[name].values;},showstate:function(name,val,mode){var result=val;var md=(mode==undefined)?`sg`:mode;if(this._showas[name]!=undefined && this._showas[name][val]!=undefined){result=this._showas[name][val][mode];}return result;},init:function(){this._getinitstate();this._addHist();},apply:function(){var that=this;return function(){var state=History.getState();if(state && state.data){that._data=state.data;that.page.apply('page');}}},};